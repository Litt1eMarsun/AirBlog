---
title: å…«è‚¡é—®é¢˜
urlname: vgighbxukdl8yam2
date: '2025-09-29 16:30:16'
updated: '2025-10-27 18:28:51'
cover: 'https://cdn.nlark.com/yuque/0/2025/png/43288584/1759134622001-1f30c8be-cdea-4c1d-9728-c79f18c68e83.png'
description: '1. +åŸºç¡€ç¯‡1.1. Attentionç›¸å…³1.1.1. ç”¨çš„æ˜¯ä»€ä¹ˆNormï¼Œè§£é‡Šä¸‹ä¸ºä»€ä¹ˆä¸ç”¨BatchNormç”¨LayerNorm1.1.2. paddinghttps://zhuanlan.zhihu.com/p/675273498æœ‰ç©ºçœ‹ä¸‹1.1.3. è¯·ä½ æ‰‹æ’•ä¸€ä¸‹GQA:è¿™æ˜¯æˆ‘æ‰‹å†™çš„G...'
---


## +åŸºç¡€ç¯‡
### Attentionç›¸å…³
#### ç”¨çš„æ˜¯ä»€ä¹ˆNormï¼Œè§£é‡Šä¸‹ä¸ºä»€ä¹ˆä¸ç”¨BatchNormç”¨LayerNorm


#### padding
[https://zhuanlan.zhihu.com/p/675273498](https://zhuanlan.zhihu.com/p/675273498)

æœ‰ç©ºçœ‹ä¸‹

#### è¯·ä½ æ‰‹æ’•ä¸€ä¸‹GQA:
è¿™æ˜¯æˆ‘æ‰‹å†™çš„Group query attention:  
ç¬¬ä¸€éï¼š

```python
import torch.nn as nn
import torch
import math
class Attention(nn.module):
    def _init_(self,args):
        super()._init_()
        self.head_dim = args.dim // args.head
        self.n_head = args.head
        self.kv_head = args.kv_head
        self.wq = nn.linear(args.dim, args.dim_head * args.head, bias=False)
        self.wk = nn.linear(args.dim, args.dim_head * args.kv_head, bias = False)
        self.wk = nn.linear(args.dim, args.dim_head * args.kv_head, bias = False)

        self.wo = nn.linear(args.dim_head * args.head, args.dim, bias=False)

        self.atten_dropout = nn.Dropout(args.atten_dropout)
        self.residual_dropout = nn.Dropout(args.residual_dropout)
        self.dropout = args.dropout

        self.n_rep = args.rep #é‡å¤kvçš„æ¬¡æ•°
    def forward(self, x:torch.Tensor, freqs_cos:torch.Tensor, freqs_sin:torch.Tensor, mask = None):
        b, seq_len, _ = x.shape

        q = self.wq(x) # è¿™é‡Œè·å¾—çš„æ˜¯dim_head * headç»´åº¦çš„qkv
        k = self.wk(x)
        v = self.wv(x)

        xq = q.view(b, seq_len, self.n_head, self.head_dim)
        xk = k.view(b, seq_len, self.kv_head, self.head_dim)
        xv = v.view(b, seq_len, self.kv_head, self.head_dim)

        # å¯¹äº§ç”Ÿçš„Qå’ŒKä½¿ç”¨RoPE
        xq,xk = apply_ROPE(q,k,freqs_cos,freqs_sin)
        
        # é‡å¤ä¸‹kå’Œv
        xk = repeat_kv(xk, self.n_rep)
        xv = repeat_kv(xv, self.n_rep)

        # å‡†å¤‡è¿›è¡Œattentionmapè¿ç®—ï¼Œç°åœ¨äº¤æ¢ä¸‹ç»´åº¦ï¼Œæ³¨æ„è¿™é‡Œçš„äº¤æ¢ç»´åº¦ä¸éœ€è¦contiguousï¼Œå› ä¸ºæ˜¯å¯¹åŸå˜é‡ç›´æ¥å˜åŒ–ï¼Œä¸æ˜¯èµ‹å€¼
        # è¯¦è§https://blog.csdn.net/kdongyi/article/details/108180250
        xq = xq.transpose(1,2)
        xv = xv.transpose(1,2)
        xk = xk.transpose(1,2)

        # attention scoreè®¡ç®—
        attention_score = torch.matmul(xq,torch.transpose(xv,2,3))/math.sqrt(self.head_dim)
        attention_score = attention_score + mask[..., :seq_len, :seq_len]
        attention_score = nn.Softmax(attention_score)
        
        # è·å¾—output
        output = torch.matmul(attention_score,xv)
        output = output.transpose(1,2).view(b,seq_len,-1) # è·å¾—output
        output = self.wo(output) # ç»è¿‡oçŸ©é˜µè·å¾—output

        return output






        attention_scores = torch.matmul(nn.Softmax(torch.matmul(xq,xk.transpose(2,3))),xv) / math.sqrt(self.head_dim * self.n_head)
```

æœ‰ä»¥ä¸‹éœ€è¦æ³¨æ„çš„

1. åˆå§‹åŒ–wqkvçŸ©é˜µ
    1. ä¸éœ€è¦biasï¼Œå å‚æ•°è¿˜æ²¡å•¥ç”¨
    2. kvçŸ©é˜µçš„ç»´åº¦æ˜¯ç‰¹æ®Šçš„ï¼Œåé¢éœ€è¦é‡å¤ï¼ŒåŸå› çœ‹çœ‹QHAè¯´ä¸å®šä¼šæœ‰è¯¦è§£
2. è¿‡äº†qkvæƒé‡
3. ä½¿ç”¨ropeåŠ è½½qkä¸Šï¼Œè¿™ä¸¤ä¸ªéœ€è¦ä½ç½®ç¼–ç 
4. é‡å¤kvï¼Œå’Œqçš„headç»´åº¦ç›¸åŒæ‰å¯ä»¥è¿›å…¥attneiton
5. è¿›å…¥attentionå‰è¦transpose headdimå’Œsqe_length
6. è®¡ç®—attentionæ—¶
    1. qkä¹˜ç§¯ä¹‹åè¦é™¤d
    2. å†åŠ mask
    3. å†softmaxåœ¨
7. è·å¾—output
    1. ä¹˜xv
    2. è½¬æ¢å›å¼€å§‹çš„ç»´åº¦ï¼Œå¹¶å°†headå’Œdimåˆå¹¶
    3. è¿‡woè·å¾—æœ€åçš„attention

è¿˜éœ€è¦æ³¨æ„ï¼š

1. dropoutæ”¾åœ¨scoreå’Œwoè¾“å‡ºä¹‹åï¼ˆä¸ºä»€ä¹ˆwoä¹‹ååšdropout?)

<details class="lake-collapse"><summary id="u4dcbe0f8"><span class="ne-text">dropoutä½ç½®åŸå› </span></summary><p id="u05f7ed9f" class="ne-p"><span class="ne-text">å¥½é—®é¢˜ </span><span class="ne-text">ğŸ‘</span><span class="ne-text">ã€‚ä½ æ³¨æ„åˆ°è¿™ä¸ª Attention é‡Œæœ‰ä¸¤ä¸ªä¸åŒä½ç½®çš„ </span><strong><span class="ne-text">dropout</span></strong><span class="ne-text">ï¼š</span></p><ol class="ne-ol"><li id="u0ed22f18" data-lake-index-type="0"><code class="ne-code"><strong><span class="ne-text">self.attn_dropout</span></strong></code><span class="ne-text"><br /></span><span class="ne-text">ç”¨åœ¨ softmax ä¹‹åçš„æ³¨æ„åŠ›æƒé‡ï¼ˆ</span><code class="ne-code"><span class="ne-text">scores</span></code><span class="ne-text">ï¼‰ä¸Šã€‚</span></li></ol><pre data-language="plain" id="MPRDS" class="ne-codeblock language-plain"><code>scores = F.softmax(scores.float(), dim=-1).type_as(xq)
scores = self.attn_dropout(scores)  # å¯¹æ³¨æ„åŠ›åˆ†å¸ƒ dropout
output = torch.matmul(scores, xv)</code></pre><p id="u7b8a4257" class="ne-p"><span class="ne-text">ğŸ‘‰</span><span class="ne-text"> è¿™ä¸€æ­¥çš„ç›®çš„ï¼š</span></p><ul class="ne-list-wrap"><ul ne-level="1" class="ne-ul"><li id="u27b99630" data-lake-index-type="0"><span class="ne-text">æŠŠæ³¨æ„åŠ›çŸ©é˜µé‡Œçš„ä¸€éƒ¨åˆ†æƒé‡â€œéšæœºå½’é›¶â€ï¼Œç›¸å½“äºéšæœºå±è”½éƒ¨åˆ† token çš„ä¿¡æ¯ã€‚</span></li><li id="u54258bb0" data-lake-index-type="0"><span class="ne-text">é˜²æ­¢æ³¨æ„åŠ›è¿‡åº¦ä¾èµ–æŸäº›ç‰¹å®šçš„ tokenï¼Œæé«˜æ¨¡å‹æ³›åŒ–èƒ½åŠ›ã€‚</span></li><li id="u57fc847b" data-lake-index-type="0"><span class="ne-text">ç±»ä¼¼äº </span><strong><span class="ne-text">DropAttention</span></strong><span class="ne-text"> çš„æ€æƒ³ã€‚</span></li></ul></ul><hr id="WUQ2L" class="ne-hr"><ol class="ne-ol"><li id="uf937a849" data-lake-index-type="0"><code class="ne-code"><strong><span class="ne-text">self.resid_dropout</span></strong></code><span class="ne-text"><br /></span><span class="ne-text">ç”¨åœ¨æœ€åè¾“å‡ºçš„æ®‹å·®è¿æ¥ä¹‹å‰ï¼š</span></li></ol><pre data-language="plain" id="izFSm" class="ne-codeblock language-plain"><code>output = self.wo(output)
output = self.resid_dropout(output)</code></pre><p id="ud056be59" class="ne-p"><span class="ne-text">ğŸ‘‰</span><span class="ne-text"> è¿™ä¸€æ­¥çš„ç›®çš„ï¼š</span></p><ul class="ne-list-wrap"><ul ne-level="1" class="ne-ul"><li id="u483cc529" data-lake-index-type="0"><span class="ne-text">å¯¹æ•´ä¸ª attention block çš„è¾“å‡ºåšéšæœºä¸¢å¼ƒã€‚</span></li><li id="ufe843bfb" data-lake-index-type="0"><span class="ne-text">è¿™æ˜¯ Transformer é‡Œæ¯”è¾ƒæ ‡å‡†çš„ä½ç½®ï¼ˆæ¯”å¦‚åŸå§‹çš„ GPT/Transformer å®ç°ä¹Ÿæ˜¯åœ¨ residual add ä¹‹å‰åš dropoutï¼‰ã€‚</span></li><li id="u18c9d1fa" data-lake-index-type="0"><span class="ne-text">å®ƒå’Œæ™®é€š dropout çš„ä½œç”¨ç±»ä¼¼ï¼šé˜²æ­¢ co-adaptationï¼Œè®©æ¨¡å‹ä¸è¦å¤ªä¾èµ–æŸäº›è·¯å¾„ã€‚</span></li></ul></ul></details>
#### GQAç›¸å¯¹äºMHAï¼ŒMQAçš„åŒºåˆ«
#### <font style="color:rgb(25, 27, 31);">å…³äºscaling sqrt(t)</font>
<font style="color:rgb(25, 27, 31);">BTWï¼Œä¸ºä»€ä¹ˆè®¡ç®—ä¸­  ä¹‹åè¿˜è¦é™¤ä»¥Sqrt(d)</font>

<font style="color:rgb(25, 27, 31);">ç®€å•æ¥è¯´ï¼Œå°±æ˜¯éœ€è¦å‹ç¼©softmaxè¾“å…¥å€¼ï¼Œä»¥å…è¾“å…¥å€¼è¿‡å¤§ï¼Œè¿›å…¥äº†softmaxçš„é¥±å’ŒåŒºï¼Œå¯¼è‡´æ¢¯åº¦å€¼å¤ªå°è€Œéš¾ä»¥è®­ç»ƒã€‚</font>

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759134622001-1f30c8be-cdea-4c1d-9728-c79f18c68e83.png)

<font style="color:rgb(25, 27, 31);">è‹å‰‘æ—çš„</font>[åšå®¢](https://link.zhihu.com/?target=https%3A//spaces.ac.cn/archives/8620)<font style="color:rgb(25, 27, 31);">ä¸­ä¹Ÿæœ‰è¯¦ç»†åˆ†æï¼Œå¹¶æåˆ°å¦‚æœä¸å¯¹attentionå€¼è¿›è¡Œscalingï¼Œä¹Ÿå¯ä»¥é€šè¿‡åœ¨å‚æ•°åˆå§‹åŒ–æ˜¯å°†æ–¹å·®é™¤ä»¥ä¸€ä¸ª  ï¼ŒåŒæ ·å¯ä»¥èµ·åˆ°é¢„é˜²softmaxé¥±å’Œçš„æ•ˆæœã€‚ç±»ä¼¼åœ°ï¼Œé€šè¿‡normalizationä¹Ÿå¯ä»¥åšåˆ°ç±»ä¼¼çš„æ•ˆæœã€‚ä¸è¿‡å®ç°ä¸Šåœ¨attentioné‡Œåšscalingè¿˜æ˜¯æ¯”è¾ƒç¨³å®šé«˜æ•ˆçš„ã€‚</font>



#### ä»‹ç»ä¸‹KV cacheæ˜¯ä»€ä¹ˆï¼Œå‚æ•°é‡å¤§å°ï¼Ÿ














### LoRAå¾®è°ƒï¼š
#### ä»‹ç»ä¸€ä¸‹LoRAå¾®è°ƒï¼š
#### SFTçš„lossæ€ä¹ˆè®¡ç®—çš„ï¼Ÿ


### trainerå®Œæ•´æ‰‹æ’•
### 
## é¡¹ç›®å»¶ä¼¸é—®é¢˜
### ä¸šåŠ¡æ•´ä½“æµç¨‹
#### ä¸šåŠ¡èƒŒæ™¯ä»‹ç»ä¸€ä¸‹ï¼Œå®Œæ•´çš„ï¼š
<font style="color:rgb(15, 17, 21);">é¢å‘é“¶è¡Œä»ä¸šè€…çš„ä¸¤ä¸ªä¸»è¦éœ€æ±‚</font>

+ **<font style="color:rgb(15, 17, 21);">é‡‘èå’¨è¯¢</font>**
+ <font style="color:rgb(15, 17, 21);">é‡‘èNLPç‰¹å®šä»»åŠ¡</font>
+ <font style="color:rgb(15, 17, 21);">é‡‘èè®¡ç®—</font>

RAGç³»ç»Ÿçš„æŸ¥è¯¢è¦æ±‚æ˜¯åŒ…å«äº†ä¸‰ç§ä¿¡æ¯çš„æŸ¥è¯¢ï¼š

ç¬¬ä¸€ç§å°±æ˜¯å¯¹æ•°æ®åº“ä¸­å­—æ®µçš„ç›´æ¥åŒ¹é…

ç¬¬äºŒç§æ˜¯ç»Ÿè®¡éœ€æ±‚ï¼Œåœ¨æ„å›¾ä¸Šå¤šäº†ä¸€ä¸ªç»Ÿè®¡æ¡ä»¶

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759825628401-7c6b0b9f-8919-40b8-acd2-ddf03cd061a8.png)

ç¬¬äºŒç§æ˜¯å¯¹å¹´æŠ¥å’Œæ•°æ®åº“çš„ç›¸å…³è®¡ç®—é¢˜ï¼ŒåŒ…æ‹¬äº†è®¡ç®—çš„ä¸€äº›éœ€æ±‚å’Œè®¡ç®—æ„å›¾

æ¯”å¦‚è¯´åœ¨ä¹‹å‰çš„æŸä¸ªæ„å›¾ä¸Šå¢åŠ äº†ä¸€äº›è®¡ç®—åè¯ï¼ˆè®¡ç®—æ„å›¾ï¼‰å¢é•¿ç‡å•Šï¼Œæ¯”å€¼å•Šï¼ŒæµåŠ¨æ¯”ç‡å•Šä¹‹ç±»çš„

ç¬¬ä¸‰ç§æ˜¯åšäº†ä¸ªsummaryï¼ˆæ€»ç»“ï¼‰é—®é¢˜ï¼Œå‰é¢æœ‰çš„æ„å›¾è¦ç´ åŸºæœ¬éƒ½æœ‰ï¼ŒåŒæ—¶åŒ…å«äº†åŸºæœ¬ä¸Šå¯¹åº”äº†è´¢æŠ¥çš„ä¸€äº›æ ‡é¢˜ä¹‹ç±»çš„

ç¬¬å››ç§æ˜¯å¯¹é‡‘èæ•°æ®åšé‡‘èçŸ¥è¯†çš„é—®ç­”ï¼Œä¸€äº›åŸºç¡€æ¦‚å¿µä¹‹ç±»çš„ã€‚æ²¡æœ‰ä»»ä½•è¦ç´ åŸºæœ¬

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759825534321-23aa9d94-6b64-46ff-981f-12ffd55e5b84.png)

<font style="color:rgb(15, 17, 21);">ä¸ºäº†è¿™äº›æ•°æ®çš„æ„é€ ï¼Œäººå·¥æ ‡æ³¨äº†1wæ¡QAæ•°æ®ç”¨æ¥åšè®­ç»ƒé›†ï¼Œå‰©ä¸‹çš„ç”¨æ¥åšæµ‹è¯•é›†ã€‚</font>

<font style="color:rgb(15, 17, 21);">ä¹‹åå¯¹è¿™äº›é—®é¢˜åšäº†ä¸€ä¸ªè¯„æµ‹ï¼Œè¯„æµ‹æ–¹æ¡ˆå¦‚ä¸‹ï¼š  
</font><font style="color:rgb(15, 17, 21);">ç­”æ¡ˆå¿…é¡»è¦å¯¹ï¼Œå’Œè´¢æŠ¥ä¸­çš„æ•°æ®å¾—ç¬¦åˆ</font>

<font style="color:rgb(15, 17, 21);">å…³é”®è¯è¦å¯¹</font>

<font style="color:rgb(15, 17, 21);">å¥å¼çš„ç›¸ä¼¼åº¦è¦å¾ˆé«˜</font>

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759827805749-7d93b108-a512-4a23-8814-7576568a3114.png)

#### ä¸šåŠ¡æ•´ä½“é€»è¾‘ä»‹ç»ä¸€ä¸‹ï¼š
![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759840524877-3916673e-8988-4155-9eb4-96a7eee409c3.png)

é¦–å…ˆæŠŠpdfè´¢æŠ¥è½¬æ¢ä¸ºjsonæ ¼å¼ï¼Œã€

è¿™ä¸ªæ–‡æ¡£çš„å¤„ç†é€»è¾‘æ˜¯

é¦–å…ˆå¯¹tableè¿›è¡Œè¯†åˆ«ï¼Œå¦‚æœç¢°åˆ°å¸¦tableçš„é¡µé¢ï¼Œå°±å•ç‹¬å¤„ç†ï¼Œå…ˆå¤„ç†tableä¸Šä¸‹çš„æ–‡æœ¬ï¼Œä¹‹åå¤„ç†tableï¼Œå†æŠŠtableæ‹¼æ¥åˆ°å…·ä½“ä½ç½®å»å³å¯

è¿™ä¸ªjsonæ ¼å¼å¤§æ¦‚å¦‚ä¸‹

```python
{"page": 1, "allrow": 0, "type": "é¡µçœ‰", "inside": "XYZè‚¡ä»½æœ‰é™å…¬å¸2021å¹´å¹´åº¦æŠ¥å‘Š"}
{"page": 1, "allrow": 1, "type": "text", "inside": "ç¬¬ä¸€èŠ‚ å…¬å¸åŸºæœ¬æƒ…å†µ"}
{"page": 1, "allrow": 2, "type": "text", "inside": "ä¸€ã€å…¬å¸ä¿¡æ¯"}
{"page": 1, "allrow": 3, "type": "text", "inside": "å…¬å¸åç§°ï¼šXYZè‚¡ä»½æœ‰é™å…¬å¸"}
{"page": 1, "allrow": 4, "type": "text", "inside": "è‹±æ–‡åç§°ï¼šXYZ Co., Ltd."}
{"page": 1, "allrow": 5, "type": "text", "inside": "äºŒã€ä¸»è¦è´¢åŠ¡æ•°æ®"}
{"page": 1, "allrow": 6, "type": "excel", "inside": "['é¡¹ç›®', '2021å¹´', '2020å¹´']"}
{"page": 1, "allrow": 7, "type": "excel", "inside": "['è¥ä¸šæ”¶å…¥', '15,000,000', '12,000,000']"}
{"page": 1, "allrow": 8, "type": "excel", "inside": "['å‡€åˆ©æ¶¦', '2,000,000', '1,800,000']"}
{"page": 1, "allrow": 9, "type": "text", "inside": "ä»¥ä¸Šæ•°æ®ç»å®¡è®¡ã€‚"}
{"page": 1, "allrow": 10, "type": "é¡µè„š", "inside": "ç¬¬1é¡µ"}
{"page": 2, "allrow": 11, "type": "é¡µçœ‰", "inside": "XYZè‚¡ä»½æœ‰é™å…¬å¸2021å¹´å¹´åº¦æŠ¥å‘Š"}
{"page": 2, "allrow": 12, "type": "text", "inside": "ç¬¬äºŒèŠ‚ åˆå¹¶åˆ©æ¶¦è¡¨"}
{"page": 2, "allrow": 13, "type": "excel", "inside": "['é¡¹ç›®', 'é™„æ³¨', '2021å¹´', '2020å¹´']"}
{"page": 2, "allrow": 14, "type": "excel", "inside": "['è¥ä¸šæ”¶å…¥', 'äº”(1)', '15,000,000', '12,000,000']"}
{"page": 2, "allrow": 15, "type": "excel", "inside": "['å‡ï¼šè¥ä¸šæˆæœ¬', 'äº”(2)', '9,000,000', '7,200,000']"}
```

åŒ…å«äº†å…·ä½“ç»“æ„çš„typeï¼Œè¿˜æœ‰æ¯è¡Œçš„å†…å®¹ã€‚

ä¹‹åæŠŠè¿™ä¸ªjsonæ•°æ®è½¬æ¢æˆæ•°æ®æ ‘çš„æ ¼å¼ï¼š

é¦–å…ˆå¯¹æ•°æ®è¿›è¡Œæ¨¡å¼è¯†åˆ«ï¼Œæ­£åˆ™åŒ¹é…ä¸€äº›æ ‡é¢˜çš„åç§°ï¼Œè¿›è¡Œæ–‡æœ¬ï¼ŒæŠ¥è¡¨çš„åˆ†ç±»ï¼ŒåŒæ—¶è¿›è¡Œå±‚çº§çš„è¯†åˆ«ï¼Œè¿˜æœ‰è„æ•°æ®çš„åç§°ã€‚

```python
@classmethod
def find_pattern(cls, text):
    # åˆ¤æ–­æ˜¯å¦ä¸ºçº¯æ•°å­—
    if is_number(text):
        return -2, ""
    
    # è¯†åˆ«è´¢åŠ¡æŠ¥è¡¨è¡¨æ ¼
    find = re.findall(tables_pattern, text)
    if len(find) > 0:
        return 6, find[0]  # ç±»å‹6è¡¨ç¤ºè´¢åŠ¡æŠ¥è¡¨

    # è¿‡æ»¤è„æ•°æ®
    for j, dpat in enumerate(dirty_patterns):
        find = re.findall(dpat, text)
        if len(find) >= 1:
            return -2, find[0]  # ç±»å‹-2è¡¨ç¤ºè„æ•°æ®
    
    # è¯†åˆ«æ ‡é¢˜å±‚çº§
    for i, pat in enumerate(patterns):
        find = re.findall(pat, text)
        if len(find) == 1 and (text.startswith(find[0]) or (i == 6 and text.endswith(find[0]))):
            if (i == 0 and text == find[0]) or i != 0:
                return i, find[0]  # è¿”å›æ ‡é¢˜å±‚çº§
    return -1, ""  # ç±»å‹-1è¡¨ç¤ºæ™®é€šæ–‡æœ¬
```

åŒ¹é…åˆ°ä¹‹åæ•°æ®æ ¼å¼å°±è¢«ä¿®æ”¹æˆï¼š  
è¿™ç§ä¿®æ”¹ç±»å‹ :

```python
è¡Œ1: "ç¬¬ä¸€ç«  å…¬å¸æ¦‚å†µ"           # type=0
è¡Œ2: "å…¬å¸åŸºæœ¬æƒ…å†µ"             # type=1  
è¡Œ3: "å…¬å¸åç§°ï¼šABCæœ‰é™å…¬å¸"     # æ™®é€šæ–‡æœ¬
è¡Œ4: [è¡¨æ ¼æ•°æ®]                # è¡¨æ ¼
è¡Œ5: "ç¬¬ä¸€èŠ‚ å‘å±•å†ç¨‹"          # type=1
è¡Œ6: "æˆç«‹äº2000å¹´"            # æ™®é€šæ–‡æœ¬
è¡Œ7: "ç¬¬äºŒç«  è´¢åŠ¡æ•°æ®"          # type=0
è¡Œ8: "åˆå¹¶åˆ©æ¶¦è¡¨"              # type=6
```

ä¹‹åå¤„ç†å®Œçš„æ•°æ®å°±æ–¹ä¾¿å­˜å…¥åˆ°doctreeè¿™ä¸ªæ•°æ®ç»“æ„å½“ä¸­äº†

```python
if type_ > last_parent.type_:
    # å­æ ‡é¢˜ï¼šåˆ›å»ºä¸ºå½“å‰çˆ¶èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
    new_node = DocTreeNode(text, type_=type_, parent=last_parent)
    last_parent.children.append(new_node)
    last_parent = new_node
else:
    # åŒçº§æˆ–æ›´é«˜çº§æ ‡é¢˜ï¼šå›æº¯åˆ°åˆé€‚çš„å±‚çº§
    while type_ <= last_parent.type_:
        last_parent = last_parent.parent
    new_node = DocTreeNode(text, type_=type_, parent=last_parent)
    last_parent.children.append(new_node)
    last_parent = new_node
```

å…·ä½“å­˜å‚¨çš„é€»è¾‘æ˜¯é¦–å…ˆè¯†åˆ«å½“å‰çš„type

+ å¦‚æœæ˜¯æ ‡é¢˜type
    - å¦‚æœæœ‰æš‚å­˜çš„ä¿¡æ¯
        * å…ˆæŠŠæš‚å­˜çš„ä¿¡æ¯å½’æ¡£åˆ°ä¸€ä¸ªå­å¶èŠ‚ç‚¹å½“ä¸­ï¼Œå¹¶ä¸”åœ¨cur_parentä¹‹ä¸‹
        * å¯»æ‰¾ä¸å½“å‰æ ‡é¢˜ç›¸åŒå±‚çº§çš„èŠ‚ç‚¹ï¼Œå¹¶åœ¨æ¬¡å¤«èŠ‚ç‚¹ä¹‹ä¸‹åˆ›å»ºæ–°çš„èŠ‚ç‚¹ï¼Œä½œä¸ºå­˜å‚¨æ­¤æ ‡é¢˜çš„èŠ‚ç‚¹ï¼Œè®°å½•å½“å‰ä¸ºcur_parents
    - å¦‚æœæ²¡æœ‰æš‚å­˜çš„ä¿¡æ¯
        * ç›´æ¥å­˜å‚¨å­å¶èŠ‚ç‚¹
        * æ›´æ–°å½“å‰çˆ¶èŠ‚ç‚¹
+ å¦‚æœæ˜¯æ–‡æœ¬/è¡¨æ ¼è¡Œåˆ—
    - æš‚å­˜åˆ°å­—å…¸å½“ä¸­

å› ä¸ºæ–‡æ¡£æœ¬èº«å°±å¸¦é¡ºåºçš„ï¼Œæ‰€ä»¥ä¾æ¬¡å­˜å‚¨åˆ°æ ‘å½“ä¸­å°±å¯ä»¥è·å¾—ä¸€æ•´ä¸ªæ–‡æ¡£æ ‘



é¦–å…ˆå°±æ˜¯pdfä¸­çš„è¡¨æ ¼æ ¼å¼æ–‡ä»¶ï¼Œpdfè½¬åŒ–ä¸ºhtmlå’Œtxtæ ¼å¼çš„ä¸¤ç§è¡¨æ ¼ï¼Œä¹‹ååˆå¹¶æ¥å‡å°‘è¡¨æ ¼çš„ä¿¡æ¯æŸå¤±

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759828557375-37714d91-bcd2-4936-9c8a-c34ac34417a8.png)

åˆå¹¶ä¹‹åæŠŠæ•°æ®ç»„æˆè¿™ä¸ªdoctreeç»“æ„

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759840535911-9a53138a-af1c-4f6c-b928-62451f661ab5.png)

ç‰¹å®šçš„ç»“æ„ï¼Œæ ‡é¢˜æ˜¯å¶èŠ‚ç‚¹ï¼Œæœ€åçš„å­å¶èŠ‚ç‚¹å°±æ˜¯textæˆ–è€…excelï¼Œåœ¨å¤„ç†sumaryç±»çš„æ€»ç»“é—®é¢˜éå¸¸é€‚ç”¨

è¿˜æœ‰ä¸€ä¸ªç»“æ„æ˜¯åº“ç»“æ„ï¼Œç›´æ¥æŠ½å–éœ€æ±‚çš„columnè¿›è¡Œå…¥åº“å³å¯ï¼š

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759840661955-c59a4dd7-f251-471c-b7c1-e75f03750a69.png)æ•°æ®åº“çš„å…¥åº“éœ€è¦å¥½å¥½äº†è§£ä¸€ä¸‹ï¼š

ä¹‹åè¿›è¡Œé—®é¢˜åˆ†ç±»ï¼šé¦–å…ˆ

åœ¨è§£ç­”è¿™å—ï¼Œ

æ ¹æ®åˆ†ç±»çš„ç»“æœï¼Œç¬¬ä¸€ç±»çš„ç»“æœå°±ç›´æ¥ä»æ•°æ®åº“ä¸­æ£€ç´¢å°±è¡Œäº†ï¼Œ é‡è¦çš„æ˜¯NL2SQL

ç›´æ¥æé—®å°±ä»æ•°æ®åº“ä¸­å¬å›å°±è¡Œäº†





å¯¹äºé—®é¢˜ä¹Ÿéœ€è¦åšæ‹†åˆ†ï¼Œåšç†è§£

è¾“å…¥åˆ°æ¨¡å‹çš„é—®é¢˜æœ‰å‡ ä¸ªä¿¡æ¯æ˜¯æœ€é‡è¦çš„ï¼š

+ é—®é¢˜ç±»å‹ï¼šæ ¹æ®ä¸åŒé—®é¢˜ç±»å‹ï¼Œè®¾è®¡ä¸åŒå›å¤æ¡†æ¶
+ æ„å›¾ï¼ˆå…³é”®è¯ï¼‰ï¼šæ¨¡å‹è·å¾—æ„å›¾ä¹‹åï¼Œèƒ½å¤Ÿæ›´æ–¹ä¾¿çš„å»å®šä½RAGï¼Œæ›´å¥½çš„å›ç­”ç”¨æˆ·é—®é¢˜ï¼Œè¯„ä¼°ä¸­çš„å‡†ç¡®ç‡ä¼šæ›´é«˜
+ å…¬å¸åŸºæœ¬ä¿¡æ¯ï¼šå…¬å¸ï¼Œå¹´ä»½ï¼Œæ–¹ä¾¿ç›´æ¥æŸ¥è¯¢æ•°æ®åº“ä¸­çš„å­—æ®µ

é¦–å…ˆé‚£éƒ½éš¾é˜Ÿæ˜¯å¯¹é—®é¢˜åšäº†ä¸ªè‡ªåŠ¨åŒ–çš„æ•°æ®æ ‡æ³¨æ¡†æ¶ï¼Œè·å¾—äº†é—®é¢˜çš„

+ æ¨¡æ¿
+ ä¸»é¢˜â€”â€”å…¬å¸å’Œå¹´ä»½
+ æ„å›¾	

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759831705855-b0efc4da-8367-4214-b99a-acd3d0fd82ba.png)

ä»è€Œå°½å¯èƒ½çš„æ»¡è¶³æµ‹è¯•é›†çš„è¦æ±‚ï¼š

å…·ä½“çš„æ ‡æ³¨è¿‡ç¨‹åŠè®­ç»ƒè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759831732416-f6024e2f-78b7-4e48-a6c0-5aaafe3d0876.png)





å¯¹äºtyp1å’Œtyp2é—®é¢˜å…¶å®è§£å†³éå¸¸å¥½è§£å†³ï¼Œ

> è¿™é‡Œä¹‹å‰æœ‰ç”¨è¿‡few-shotå—ï¼Œä¸ºä»€ä¹ˆä¸ç”¨few-shotå‘¢ï¼Ÿ
>
> ä¸ºä»€ä¹ˆè¦å¾®è°ƒè¿™ä¸ªæ¨¡å‹å‘¢ï¼Ÿåˆ«çš„ä¸è¡Œå—	
>

ç›´æ¥ä½¿ç”¨nl2sqlå¾®è°ƒä¸€ä¸‹ï¼Œè¿™æ ·èƒ½ä»questionç›´æ¥è·å¾—å¯¹åº”çš„sqlå³å¯ï¼Œæ„Ÿè§‰å¤§å®¶çš„æ€è·¯éƒ½å¾ˆä¸€è‡´ï¼Œä¸»è¦çœ‹æ˜¯æ€ä¹ˆå¬å›æ•°æ®åˆ—çš„ï¼Œæ€ä¹ˆæ”¶é›†nl2sqlæ•°æ®çš„ï¼Œå¾®è°ƒæµç¨‹æ˜¯ä»€ä¹ˆæ ·çš„

é¦–å…ˆè¾“å…¥æ˜¯NLå’Œå¬å›çš„æ•°æ®åˆ—ï¼Œè¾“å‡ºæ˜¯SQLè¯­å¥ã€‚ 

åœ¨å¾®è°ƒä¹‹å‰æ¯”è¾ƒé‡è¦çš„æ˜¯å¬å›æ•°æ®åˆ—ï¼Œæ¯•ç«Ÿæ•°æ®çš„å‡†å¤‡éƒ½éœ€è¦åœ¨å¬å›æ•°æ®åˆ—çš„åŸºç¡€ä¸Šå»å‡†å¤‡

å¬å›æ•°æ®åˆ—çš„è¿‡ç¨‹å¦‚ä¸‹ã€‚

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1760010733309-0fff5d2f-e706-4895-b2ea-c860428cd927.png)

é¦–å…ˆå¯¹æé—®è¿›è¡Œåˆ†è¯ã€‚è¿™é‡Œåˆ†è¯ç”¨çš„jiebaå»è¿›è¡Œåˆ†è¯

ä¹‹åå¯¹åˆ†å¥½çš„è¯åšä¸€äº›å»åœè¯ï¼Œåœ¨ä¹‹ç±»çš„æ•°æ®éƒ½ä¼šå»æ‰ã€‚

æœ€åç›´æ¥ç”¨å‰©ä¸‹çš„è¯åšä¸ªembeddingï¼Œå»æ•°æ®åº“ä¸­çš„è¯çš„embeddingåšåŒ¹é…ã€‚

åŒ¹é…ä¹‹åå¯èƒ½æœ‰äº›ä¸æ˜¯å¾ˆå‡†ï¼Œæ‰€ä»¥ç”¨äº†ç¼–è¾‘è·ç¦»å»å¡ä¸€ä¸‹æ•°æ®åˆ—çš„å¬å›ç»“æœï¼Œé¿å…æ‰¾å›åˆ°é”™è¯¯çš„éƒ¨åˆ†

é™¤äº†å¬å›çš„æ•°æ®åˆ—ï¼Œæœ‰ä¸€äº›å¹´ä»½å•Šï¼Œå…¬å¸åç§°å•Šçš„æ•°æ®åˆ—æ˜¯å¿…é¡»éœ€è¦çš„ï¼Œæ‰€ä»¥ï¼Œå†å°†å¬å›çš„æ•°æ®åˆ—å’Œå¿…é¡»è¦çš„æ•°æ®åˆ—è¿›è¡Œæ‹¼æ¥ï¼Œè·å¾—æ•°æ®åˆ—ã€‚

<details class="lake-collapse"><summary id="u0df597c3"><span class="ne-text">ä¼˜åŒ–ï¼šæå‡å¬å›ç‡</span></summary><p id="ud3a6d0fa" class="ne-p"><span class="ne-text">å¯¹äºå½“å‰çš„å¯†é›†æ£€ç´¢ï¼Œ</span></p><p id="uad6f41d9" class="ne-p" style="margin-left: 2em"><span class="ne-text">å¯ä»¥æ‰©å……åˆ—åå˜æˆåˆ—æ–‡æ¡£ï¼Œæ¯”å¦‚è¯´äººå‘˜è¡¨é‡Œæœ‰ç”Ÿæ—¥ï¼Œ col_name  è¡¥å……è¯­ä¹‰ä¹‹ç±»çš„ï¼Œä¹‹åå¯¹æ•´ä¸ªåˆ—æ–‡å½“åšembeddingå¹¶åŒ¹é…ï¼Œè¿™æ ·å¯¹æå‡ä¼šæœ‰æ•ˆæœ</span></p><p id="u1d066da8" class="ne-p"><span class="ne-text">ä¹Ÿå¯ä»¥å¢åŠ ä¸€ä¸ªæ—è·¯ï¼šç¨€ç–æ£€ç´¢ï¼Œå¯¹queryä¸­çš„æ•°æ®ä¸åˆ—ååšç›´æ¥æ˜ å°„</span></p><ol class="ne-ol"><li id="u1d6c4195" data-lake-index-type="0"><span class="ne-text">ç¨€ç–æ£€ç´¢çš„æ‰‹æ®µ</span></li></ol><p id="ua696ddaa" class="ne-p" style="margin-left: 2em"><span class="ne-text">è¿™ç§å¯ä»¥ä½¿ç”¨è§„åˆ™åŒ¹é…ï¼Œå¯¹åº”å­—æ®µçš„ç›´æ¥åŒ¹é…ï¼Œä¹‹åç”¨å¯†é›†æ£€ç´¢åšè¡¥å……</span></p><p id="u7088aabc" class="ne-p" style="margin-left: 2em"><span class="ne-text">ä¹Ÿå¯ä»¥ä½¿ç”¨ç±»ä¼¼äºtokenizerçš„è¯è¡¨æ˜ å°„ï¼Œå…·ä½“æŠ€æœ¯æ˜¯bm25</span></p><ol start="2" class="ne-ol"><li id="u2e2c70b7" data-lake-index-type="0"><span class="ne-text">ä¹‹åå†è¿›è¡Œä¸¤è€…çš„åˆå¹¶ï¼Œçº¿æ€§åŠ æƒå³å¯ï¼Œå‚æ•°çœ‹å¬å›ç‡æ‰‹åŠ¨é€‰æ‹©ï¼Œå–topkä¸ª</span></li><li id="ua960fbec" data-lake-index-type="0"><span class="ne-text">ç²¾æ’å–å‰äº”ä¸ª</span></li></ol><p id="uc53237a4" class="ne-p" style="text-indent: 2em"><br></p><p id="u9b369a3d" class="ne-p" style="text-indent: 2em"><span class="ne-text"></span></p></details>
<details class="lake-collapse"><summary id="ue6650468"><span class="ne-text">è¯„ä¼°</span></summary><p id="uee39e9b5" class="ne-p"><span class="ne-text">è¯„ä¼°æ„Ÿè§‰ä¸ç”¨åšå¤šå°‘ï¼Œé‡è¦çš„æ˜¯ä¸‹æ¸¸sqlçš„å‡†ç¡®ç‡ï¼Œ</span></p><p id="u3b601dbc" class="ne-p"><span class="ne-text">åªæ˜¯æŠ½æ£€äº†å‡ ä¸ªå¤§æ¦‚çœ‹äº†ä¸€ä¸‹ï¼Œæ»¡è¶³å¤§è‡´è¦æ±‚ï¼Œå°±æ²¡å¯¹è¿™éƒ¨åˆ†è¿›è¡Œä¼˜åŒ–äº†</span></p></details>
ä¹‹åæ˜¯å®é™…æ„å»ºæ•°æ®é›†è¿™éƒ¨åˆ†äº†

åœ¨ç”Ÿæˆsqlçš„é˜¶æ®µ

é¦–å…ˆæ˜¯åŸºäºè§„åˆ™ï¼ˆå…³é”®è¯æ‹†è§£ï¼‰ï¼Œè¿™æ ·å¯ä»¥å¾—åˆ°ä¸€äº›SQL

ä½†æ˜¯å¯¹äºä¸€äº›å¤æ‚é—®é¢˜ï¼Œå†™è§„åˆ™å¤ªéº»çƒ¦äº†å°±ä½¿ç”¨chatgptå»ç”Ÿæˆsql

ä¹‹åå°†æ‰€æœ‰çš„é—®é¢˜ç»„åˆæˆæ•°æ®ï¼Œå°±å¯ä»¥è¿›è¡Œå¾®è°ƒäº†ã€‚å¾®è°ƒçš„æ•°æ®å†æ ‡æ³¨å¤æ‚çš„queryï¼Œå¯¹é”™è¯¯çš„è¿›è¡Œäººå·¥å®¡æ ¸ï¼Œç”ŸæˆV2ä¹‹åå†è¿›è¡Œå¾®è°ƒï¼Œå°±å¯ä»¥å®Œæˆæ•°æ®é›†æ€§èƒ½çš„è¿­ä»£äº†

> è¿™é‡Œä¸€å®šè¦æ³¨æ„ä»¥ä¸‹badcaseåŠå…¶ä¼˜åŒ–
>

 

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759845191991-84da146b-09f5-4160-9072-80d0792fbd3f.png)

> ä¹‹åçš„å¾®è°ƒç»†èŠ‚è¦æ³¨æ„ä¸€ä¸‹ï¼Œä»¥åŠå¾®è°ƒç»“æœçš„è¯„ä¼°
>

æœ€ç»ˆæ ‡æ³¨å‡ºæ¥çš„æ•°æ®é›†æ˜¯1400å¤šæ¡SQLä½œä¸ºæ•°æ®é›†è¿›è¡Œçš„å¾®è°ƒ

> è¿™é‡Œæ•°æ®é›†ä¸ºä»€ä¹ˆä¸ç”¨å…¬ç”¨çš„ï¼Ÿ
>

æ¥ä¸‹æ¥ä»‹ç»è¯¦ç»†çš„å¾®è°ƒè¿‡ç¨‹å’Œå‚æ•°é…ç½®

å…·ä½“å¾®è°ƒçš„å…·ä½“å‚æ•°è®¾ç½®å¦‚ä¸‹ï¼š

```python
1. åŸºæœ¬é…ç½®
--stage sftï¼šæŒ‡å®šè®­ç»ƒé˜¶æ®µï¼Œè¿™é‡Œæ˜¯ç›‘ç£å¾®è°ƒï¼ˆSupervised Fine-Tuning, SFTï¼‰ã€‚
--do_train Trueï¼šæŒ‡å®šæ˜¯å¦è¿›è¡Œè®­ç»ƒï¼ŒTrueè¡¨ç¤ºè¿›è¡Œè®­ç»ƒã€‚ false ä¸ºä¸è®­ç»ƒ
--model_name_or_path /home/util/muyan/Qwen/Qwen2.5-7B-Instructï¼šæŒ‡å®šé¢„è®­ç»ƒæ¨¡å‹çš„è·¯å¾„ã€‚
--output_dir saves/Qwen2.5-7B-Instruct/lora/train_2024-11-20-16-00-00ï¼šæŒ‡å®šè¾“å‡ºç›®å½•ï¼Œä¿å­˜è®­ç»ƒç»“æœå’Œæ—¥å¿—ã€‚

2. æ•°æ®å¤„ç†
--preprocessing_num_workers 16ï¼šæŒ‡å®šé¢„å¤„ç†æ•°æ®æ—¶ä½¿ç”¨çš„çº¿ç¨‹æ•°ã€‚æé«˜æ•°æ®é¢„å¤„ç†é€Ÿåº¦ï¼Œä½†å¯èƒ½å¢åŠ CPUå’Œå†…å­˜èµ„æºçš„æ¶ˆè€—ï¼Œé€šå¸¸æ˜¯æ€»æ ¸æ•°-1æˆ–è€…-2
--dataset_dir LLaMA-Factory/dataï¼šæŒ‡å®šæ•°æ®é›†ç›®å½•ã€‚
--dataset alpaca_dev,sharegpt_cosql_trainï¼šæŒ‡å®šä½¿ç”¨çš„æ•°æ®é›†ï¼Œå¯ä»¥æ˜¯å¤šä¸ªæ•°æ®é›†ï¼Œç”¨é€—å·åˆ†éš”ã€‚
--cutoff_len 2048ï¼šæŒ‡å®šè¾“å…¥åºåˆ—çš„æœ€å¤§é•¿åº¦ã€‚ è°ƒå°æ¨¡å‹åªèƒ½å¤„ç†è¾ƒçŸ­çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¯èƒ½ä¼šä¸¢å¤±ä¸€äº›é‡è¦çš„ä¸Šä¸‹æ–‡ï¼Œå½±å“æ¨¡å‹çš„æ€§èƒ½ï¼Œä½†æ˜¯æ€§èƒ½ä¼šèŠ‚çº¦
--max_samples 100000ï¼šæŒ‡å®šæœ€å¤šä½¿ç”¨çš„æ ·æœ¬æ•°é‡ã€‚
                    å¢å¤§ï¼šæ›´å¤šçš„æ ·æœ¬å¯ä»¥æä¾›æ›´å¤šçš„è®­ç»ƒä¿¡å·ï¼Œæœ‰åŠ©äºæ¨¡å‹å­¦ä¹ åˆ°æ›´ä¸°å¯Œçš„ç‰¹å¾å’Œæ¨¡å¼ï¼Œå¯èƒ½æé«˜æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚
                    å‡å°ï¼šè¾ƒå°‘çš„æ ·æœ¬å¯èƒ½å¯¼è‡´æ¨¡å‹è¿‡æ‹Ÿåˆï¼Œæ— æ³•å……åˆ†å­¦ä¹ åˆ°æ•°æ®çš„å¤šæ ·æ€§ï¼Œå½±å“æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚

3. è®­ç»ƒé…ç½®
--num_train_epochs 3.0ï¼šæŒ‡å®šè®­ç»ƒçš„æ€»è½®æ•°ã€‚
    æ¨¡å‹ä¼šåœ¨æ•´ä¸ªæ•°æ®é›†ä¸Šè¿›è¡Œæ›´å¤šçš„è½®æ¬¡è®­ç»ƒï¼Œæœ‰æœºä¼šå­¦ä¹ åˆ°æ›´å¤šç»†èŠ‚ï¼Œæé«˜æ¨¡å‹æ€§èƒ½ï¼Œä½†ä¹Ÿå¯èƒ½å¢åŠ è¿‡æ‹Ÿåˆçš„é£é™©ã€‚
--per_device_train_batch_size 2ï¼šæŒ‡å®šæ¯ä¸ªè®¾å¤‡ä¸Šçš„è®­ç»ƒæ‰¹æ¬¡å¤§å°ã€‚
    æ›´å¤§çš„æ‰¹æ¬¡å¤§å°å¯ä»¥æä¾›æ›´ç¨³å®šçš„æ¢¯åº¦ä¼°è®¡ï¼Œæœ‰åŠ©äºæ¨¡å‹æ”¶æ•›ï¼Œä½†å¯èƒ½ä¼šå¯¼è‡´æ¨¡å‹è¿‡æ‹Ÿåˆã€‚
--gradient_accumulation_steps 8ï¼šæŒ‡å®šæ¢¯åº¦ç´¯ç§¯æ­¥éª¤æ•°ï¼Œç”¨äºæ¨¡æ‹Ÿæ›´å¤§çš„æ‰¹æ¬¡å¤§å°ã€‚
    æé«˜æ¨¡å‹ç¨³å®šæ€§ï¼Œä½†å¢åŠ å†…å­˜ä½¿ç”¨å’Œè®­ç»ƒæ—¶é—´ã€‚
--learning_rate 5e-05ï¼šæŒ‡å®šå­¦ä¹ ç‡ã€‚ç­‰ä»·äº 0.00005 ç›¸å½“ä¸å°æ•°ç‚¹å¾€å‰ç§»åŠ¨äº†5ä½æ•° å¦‚æœæ˜¯3e-5 å¯¹åº”çš„æ˜¯0.00003ï¼Œe-6å°æ•°ç‚¹å¾€å‰ç§»åŠ¨å…­ä½
    æƒé‡æ›´æ–°çš„æ­¥é•¿å¯èƒ½ä¼šå¤ªå¤§ï¼Œå¯¼è‡´æ¨¡å‹åœ¨æŸå¤±å‡½æ•°çš„æœ€å°å€¼é™„è¿‘éœ‡è¡ï¼Œç”šè‡³å‘æ•£ï¼Œæ— æ³•æ”¶æ•›åˆ°æœ€ä¼˜è§£ã€‚æˆ–è€…æ˜¯è¿‡æ‹ŸåˆçŠ¶æ€
    åä¹‹å®¹æ˜“æ¬ æ‹Ÿåˆå¾ˆéš¾å‘æŒ¥æ¨¡å‹æœ€å¥½æ€§èƒ½
--lr_scheduler_type cosineï¼šæŒ‡å®šå­¦ä¹ ç‡è°ƒåº¦å™¨ç±»å‹ï¼Œè¿™é‡Œæ˜¯ä½™å¼¦é€€ç«ã€‚å¸®åŠ©æ¨¡å‹åœ¨æ¥è¿‘æœ€ä¼˜è§£æ—¶è¿›è¡Œæ›´ç»†è‡´çš„è°ƒæ•´ï¼Œæé«˜æ”¶æ•›æ€§å’Œæœ€ç»ˆçš„æ¨¡å‹æ€§èƒ½
    Constant:é€‚åˆäºéœ€è¦ç¨³å®šå­¦ä¹ ç‡çš„ä»»åŠ¡ï¼Œå°¤å…¶æ˜¯åœ¨æ¨¡å‹å·²ç»ç»è¿‡é¢„è®­ç»ƒå¹¶ä¸”åªéœ€å¾®è°ƒçš„æƒ…å†µä¸‹ã€‚
    Cosine Annealingï¼šè®­ç»ƒå‘¨æœŸè¾ƒé•¿çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥æœ‰æ•ˆé¿å…åœ¨è®­ç»ƒåæœŸçš„éœ‡è¡ã€‚
--warmup_steps 0ï¼šæŒ‡å®šå­¦ä¹ ç‡é¢„çƒ­æ­¥æ•°ã€‚
--max_grad_norm 1.0ï¼šæŒ‡å®šæ¢¯åº¦è£å‰ªçš„æœ€å¤§èŒƒæ•°ã€‚
    è°ƒå¤§ä¼šåŠ é€Ÿæ”¶æ•›ï¼Œä½†å¯èƒ½ä¼šé€ æˆæ¢¯åº¦çˆ†ç‚¸ï¼Œå°ä¼šæ…¢ï¼Œä½†æ˜¯ç›¸å¯¹æ”¶æ•›é€Ÿåº¦è¾ƒæ…¢
--logging_steps 5ï¼šæŒ‡å®šæ¯å¤šå°‘æ­¥è®°å½•ä¸€æ¬¡æ—¥å¿—ã€‚
    ä¸»è¦è®°å½•æ—¥å¿—ä¿¡æ¯ï¼Œè°ƒå¤§ä¼šèŠ‚çº¦ç©ºé—´ï¼Œå°äº†ä¼šè¯¦ç»†ä½†æ˜¯ç›¸å¯¹èŠ±è´¹æ—¶é—´å¤šä¸€äº›
--save_steps 100ï¼šæŒ‡å®šæ¯å¤šå°‘æ­¥ä¿å­˜ä¸€æ¬¡æ¨¡å‹æ£€æŸ¥ç‚¹ã€‚
    ä¼šåšä¸­é—´èŠ‚ç‚¹çš„ä¿å­˜ï¼Œè°ƒå¤§é¢‘ç‡ä¼šä½ï¼Œä¼šèŠ‚çº¦ç©ºé—´ï¼Œè°ƒå°ä¿å­˜æ­¥éª¤æ›´åŠ è¯¦ç»†ã€‚
--packing Falseï¼šæŒ‡å®šæ˜¯å¦ä½¿ç”¨æ‰“åŒ…æŠ€æœ¯ã€‚
    True:æ‰“åŒ…æŠ€æœ¯å¯ä»¥æé«˜è®­ç»ƒæ•ˆç‡ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†çŸ­åºåˆ—æ•°æ®æ—¶ï¼Œä½†å¯èƒ½ä¼šå¢åŠ æ•°æ®é¢„å¤„ç†çš„å¤æ‚æ€§ã€‚
    False:ä¸ä½¿ç”¨æ‰“åŒ…æŠ€æœ¯ï¼Œè®­ç»ƒè¿‡ç¨‹æ›´ç®€å•ï¼Œä½†å¯èƒ½ä¼šå› ä¸ºå¡«å……å¸¦æ¥çš„è®¡ç®—æµªè´¹è€Œé™ä½æ•ˆç‡
--report_to noneï¼šæŒ‡å®šæŠ¥å‘Šè®­ç»ƒè¿›åº¦çš„æ–¹å¼ï¼Œnoneè¡¨ç¤ºä¸æŠ¥å‘Šã€‚
    ç±»ä¼¼TensorBoard è¿™æ ·çš„å¤–éƒ¨ç³»ç»Ÿ

4. ä¼˜åŒ–å™¨å’Œæ··åˆç²¾åº¦
--fp16 Trueï¼šæŒ‡å®šæ˜¯å¦ä½¿ç”¨æ··åˆç²¾åº¦è®­ç»ƒã€‚
    å¦‚æœæ˜¾ç¤ºfp32 åˆ™ä¸ä¼šæœ‰å½“å‰å‘½ä»¤ç”Ÿæˆ
--optim adamw_torchï¼šæŒ‡å®šä¼˜åŒ–å™¨ç±»å‹ï¼Œè¿™é‡Œæ˜¯AdamWã€‚ åœ¨å…¶ä»–å‚æ•°è®¾ç½®ä¸€æ ä¸­è¿›è¡Œè®¾ç½®{"optim": "adamw_torch"}
    å¦‚ Adamã€SGD ä¼šå½±å“æ¨¡å‹çš„æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ€§èƒ½ã€‚
--ddp_timeout 180000000ï¼šæŒ‡å®šåˆ†å¸ƒå¼è®­ç»ƒçš„è¶…æ—¶æ—¶é—´ã€‚
    æ›´å¤§çš„è¶…æ—¶æ—¶é—´å¯ä»¥ç»™è¿›ç¨‹æ›´å¤šçš„æ—¶é—´æ¥åŒæ­¥ï¼Œé¿å…å› ç½‘ç»œå»¶è¿Ÿæˆ–è®¡ç®—å·®å¼‚å¯¼è‡´çš„è®­ç»ƒä¸­æ–­ï¼Œå°äº†å¯èƒ½å› ä¸ºæŸäº›ç½‘ç»œåŠ¨è¡è€Œé€ æˆä¸­æ–­ã€‚

5. LoRA é…ç½®
--finetuning_type loraï¼šæŒ‡å®šå¾®è°ƒç±»å‹ï¼Œè¿™é‡Œæ˜¯LoRAï¼ˆLow-Rank Adaptationï¼‰ã€‚
    é€‰æ‹©å…¶ä»–ç±»å‹ä¼šå¯¹åº”å˜åŒ– ä¾‹å¦‚ï¼šfreeze
--lora_rank 8ï¼šæŒ‡å®šLoRAçš„ç§©ã€‚
    LoRA çš„ç§©å†³å®šäº†æ·»åŠ çš„ä½ç§©çŸ©é˜µçš„å¤§å°ã€‚ç§©è¶Šå°ï¼Œæ·»åŠ çš„å‚æ•°é‡è¶Šå°‘ï¼Œè®¡ç®—å¼€é”€ä¹Ÿè¶Šå°ã€‚è¿™ä¸ªéœ€è¦å› å¾®è°ƒåœºæ™¯æ•ˆæœæ¥å˜æ›´
--lora_alpha 16ï¼šæŒ‡å®šLoRAçš„æ¯”ä¾‹å› å­ã€‚
    LoRA çš„æ¯”ä¾‹å› å­ï¼ˆalphaï¼‰ç”¨äºç¼©æ”¾ä½ç§©çŸ©é˜µçš„è´¡çŒ®ã€‚è¾ƒå¤§çš„ alpha å€¼å¯ä»¥ä½¿ä½ç§©çŸ©é˜µçš„è´¡çŒ®æ›´å¤§ï¼Œä»è€Œå¢å¼ºå¾®è°ƒçš„æ•ˆæœã€‚è®©rankçš„ä½œç”¨æ›´å¤§ï¼Œå¯èƒ½ä¼šå¯¼è‡´è¿‡æ‹Ÿåˆã€‚
--lora_dropout 0ï¼šæŒ‡å®šLoRAçš„dropoutæ¦‚ç‡ã€‚
    è°ƒå¤§ï¼šå¢åŠ æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ï¼Œå‡å°‘è¿‡æ‹Ÿåˆï¼Œè°ƒå°ï¼šå‡å°‘æ¨¡å‹çš„æ­£åˆ™åŒ–ï¼Œå¯èƒ½æé«˜æ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›
--lora_target allï¼šæŒ‡å®šLoRAçš„ç›®æ ‡å±‚ï¼Œallè¡¨ç¤ºæ‰€æœ‰å±‚ã€‚éƒ¨åˆ†å‚æ•°å¾®è°ƒè®¾ç½®
    å¯ä»¥æŒ‡å®šç‰¹å®šå±‚è°ƒæ•´
    q_projï¼šæŸ¥è¯¢æŠ•å½±å±‚
    v_projï¼šå€¼æŠ•å½±å±‚
    k_projï¼šé”®æŠ•å½±å±‚
    fcï¼šå…¨è¿æ¥å±‚

```

å› ä¸ºåœ¨ä»¥ä¸Šé…ç½®ä¸‹ä¹Ÿæ˜¯å ç”¨äº†48gå·¦å³çš„æ˜¾å­˜ï¼Œè®­äº†äºŒä¸‰ååˆ†é’Ÿã€‚

æƒ³å°è¯•ä¸€ä¸‹ç¼©çŸ­ä¸€ä¸‹å¾®è°ƒéœ€è¦çš„æ—¶é—´ï¼Œä½¿ç”¨äº†deepspeedå»è¿›è¡Œæ—¶é—´ç¼©çŸ­

```markdown
ç”Ÿæˆå‘½ä»¤åªå¢åŠ äº†deepspeed cache/ds_z3_offload_config.json
```json
llamafactory-cli train \
    --stage sft \
    --do_train True \
    --model_name_or_path /home/util/muyan/Qwen/Qwen2.5-7B-Instruct \
    --preprocessing_num_workers 16 \
    --finetuning_type lora \
    --template qwen \
    --flash_attn auto \
    --dataset_dir LLaMA-Factory/data \
    --dataset alpaca_dev,sharegpt_cosql_train \
    --cutoff_len 2048 \
    --learning_rate 5e-05 \
    --num_train_epochs 3.0 \
    --max_samples 100000 \
    --per_device_train_batch_size 2 \
    --gradient_accumulation_steps 8 \
    --lr_scheduler_type cosine \
    --max_grad_norm 1.0 \
    --logging_steps 5 \
    --save_steps 100 \
    --warmup_steps 0 \
    --packing False \
    --report_to none \
    --output_dir saves/Qwen2.5-7B-Instruct/lora/train_2024-11-20-18-17-40 \
    --fp16 True \
    --plot_loss True \
    --ddp_timeout 180000000 \
    --optim adamw_torch \
    --lora_rank 8 \
    --lora_alpha 16 \
    --lora_dropout 0 \
    --lora_target all \
    --deepspeed cache/ds_z3_offload_config.json
```
```

ä½¿ç”¨äº†deepspeed zero3å»å‡å°‘å†…å­˜çš„å ç”¨ï¼Œä¹‹åçš„å†…å­˜å ç”¨å¦‚ä¸‹

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1760019000089-ccd96a8f-8cb0-42f0-baa7-3f11be992680.png)

å‡å°‘äº†ä¸€åŠ

è¯„ä¼°ï¼šç”¨è¯„æµ‹é›†ä¸­çš„sqlç›´æ¥å–æ•°æ®ï¼Œå¹¶ä¸æ¨ç†äº§ç”Ÿçš„æ•°æ®ç›´æ¥ç®—losså³å¯

ä»‹ç»ä¸€ä¸‹ä¸Šè¿°æƒ…å†µçš„badcaseåŠå¤„ç†çš„æ–¹æ³•ï¼š

badcase1:

NL2SQLçš„ç»“æœä¸­ä¼šå‡ºç°éƒ¨åˆ†å®ä½“æ²¡æœ‰åŠæ³•è§£æçš„æƒ…å†µï¼Œæ¯”å¦‚è¯´æŸäº›ç‰¹æ®Šçš„å…¬å¸åNL2SQLæ²¡æœ‰åŠæ³•è§£æå‡ºæ¥ï¼Œé‚£å°±å†ä¸€å¼€å§‹çš„æ•°æ®åˆ—å¬å›çš„æ—¶å€™ ï¼Œå°†è¯†åˆ«å‡ºæ¥çš„æ•°æ®åˆ—å’Œå…¬å¸åç§°è¿›è¡Œç»„åˆ 



![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1760013558902-eb853702-0b19-4839-8930-142d8d3afe68.png)

ç»„åˆæ–¹å¼ä¹Ÿå¾ˆç®€å•ï¼Œæ­£åˆ™åŒ¹é…ï¼Œæ¯”å¦‚è¯´å…¬å¸åç§°åŸºæœ¬ä¸Šéƒ½å¸¦ä¸€ä¸ªå…¬å¸ã€‚è¿™æ ·å°±å¯ä»¥å‡å°‘å…¬å¸å®ä½“è¯†åˆ«ä¸å‡ºæ¥çš„æ¦‚ç‡äº†ã€‚

badcase2:

ç»„åˆä»»åŠ¡è¿‡äºå¤æ‚ã€‚æœ‰äº›è¾“å‡ºä¸äº†å¸ƒå°”å€¼ä¹‹ç±»çš„SQLè¯­å¥

å¯¹å¤æ‚ä»»åŠ¡ç›´æ¥è¿›è¡Œåˆ å‡ï¼Œæ¯”å¦‚è¯´ä¿ç•™ä¸¤ä½å°æ•°ï¼Œä¸è¦æ±‚ä¿ç•™ä¸¤ä½å°æ•°ã€‚åœ¨è¿™ç§éœ€è¦åŠ ä¸Šé¢å¤–é€»è¾‘çš„labelç›´æ¥ç»™ä»–åˆ æ‰ï¼Œåšç®€å•SQLå°±å¯ä»¥äº†

ä¹‹åæŠŠç®€å•SQLçš„ç»“æœç»™åˆ°æ¨¡å‹å½“ä¸­ï¼Œè®©æ¨¡å‹è¡¥å…¨åé¢çš„æ­¥éª¤

æœ€åè¯´ä¸€ä¸‹è¯„ä¼°

ç»™çš„ä¸€å¼€å§‹çš„NL2SQLçš„æ•°æ®æ˜¯70%çš„å‡†ç¡®ç‡ï¼Œå¾®è°ƒä¹‹å98%



ä¹‹åè¿›è¡Œnormalizeï¼Œä½œä¸ºäººæœºæ¥å£å»å›ç­”çš„äº²åˆåº¦ï¼Œè¿™ä¸€æ®µæ›¿æ¢ä¸ºdpoè¿›è¡Œå§ã€‚è‡³æ­¤ç¬¬ä¸€ç±»çš„ç›´æ¥å›ç­”è¦æ±‚å·²ç»åšå¥½äº†ã€‚

ä¹‹åå°±æ˜¯é’ˆå¯¹typ3è¿›è¡Œå›ç­”äº†ï¼ŒåŒ…æ‹¬äº†

é€»è¾‘å°±æ˜¯æ™®é€šçš„RAGé€»è¾‘

å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨pdfï¼Œ

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759847671152-ec385827-8857-4f7f-abf3-72617ac2b869.png)

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759902591427-589c667c-5eca-465a-9e93-d0575ec8b614.png)

è¿™æ˜¯æ­å»ºRAGå…·ä½“çš„ä¼ä¸šçº§æµç¨‹ 

è¿™ä¸ªæ­å¥½äº†ä¹‹åä»ç„¶è§‚å¯Ÿåˆ°é—®é¢˜

æŠŠbadcaseæ‹¿å‡ºæ¥ä¼šå‘ç°è¿™äº›  

+ æ¦‚å¿µç†è§£ä¸äº†ï¼Œ**ä¿¡æ¯æ£€ç´¢å¯¹ä½†ç†è§£é”™**ï¼ˆsemantic groundingå¤±è´¥ï¼‰  
+ é€»è¾‘æ–­è£‚ï¼Œæ²¡åŠæ³•ç†æ¸…æ¥šé€»è¾‘ï¼Œ**ç¼ºä¹é¢†åŸŸé€»è¾‘æ¨ç†**ï¼ˆfinancial reasoningä¸è¶³ï¼‰  

åœ¨å›ç­”â€œ**å…¬å¸2023å¹´å‡€åˆ©æ¶¦åŒæ¯”ä¸‹é™çš„ä¸»è¦åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ**â€æ—¶ï¼Œæ¨¡å‹è™½ç„¶æ£€ç´¢åˆ°â€œæ¯›åˆ©ç‡ä¸‹é™â€å’Œâ€œæ±‡å…‘æŸå¤±å¢åŠ â€çš„æ®µè½ï¼Œä½†ç”Ÿæˆå›ç­”æ—¶é”™è¯¯åœ°å°†å…¶å½’å› ä¸ºâ€œç®¡ç†è´¹ç”¨ä¸Šå‡â€ï¼Œå‡ºç°**è¯­ä¹‰é”™é…ä¸é€»è¾‘è·³è·ƒ**ï¼›  

æ•´ç†çš„æ•°æ®æ€è·¯æ˜¯ï¼š

1. badcaseæ‹¿å‡ºæ¥ï¼Œè®©å¤§æ¨¡å‹åˆ†ç±»ï¼Œå“ªäº›æ˜¯æ¦‚å¿µç†è§£çš„é—®é¢˜ï¼Œå“ªäº›æ˜¯é€»è¾‘é“¾æ–­è£‚çš„é—®é¢˜ï¼Œå“ªäº›æ˜¯æ£€ç´¢ä¸å…¨çš„é—®é¢˜ã€‚
2. å¯¹äºæ¦‚å¿µç†è§£ç±»é—®é¢˜å‡ºé”™ï¼ŒæŠŠæ¦‚å¿µç†è§£ç±»çš„badcaseæ‹¿å‡ºæ¥ï¼Œå¤§æ¨¡å‹æ•´ç†å‡ºæœ‰é—®é¢˜çš„æ¦‚å¿µï¼Œå¹¶æ ¹æ®æ¦‚å¿µé‡æ–°ç”ŸæˆQAï¼ŒåŒæ—¶æ··æœ‰äº†ä¸€éƒ¨åˆ†è¿›å…¥é—®ç­”QAæ•°æ®é›†æ¥å¢å¼ºæ³›åŒ–æ€§ã€‚
3. å¯¹äºé€»è¾‘é“¾æ–­è£‚çš„é—®é¢˜ï¼ŒæŠŠbadcaseå–å‡ºæ¥ï¼Œæå–å‡ºé—®é¢˜æ¨¡æ¿ï¼Œå¹¶æ›´æ¢æ•°æ®åˆ—ï¼Œè·å¾—å¤§é‡æ•°æ®ä¹‹åï¼Œè¾“å…¥åˆ°deepseekR1å½“ä¸­è·å¾—cot+å›ç­”ï¼Œç»„æˆæ•°æ®é›†ã€‚
4. ä¹‹åä¸ºäº†è®©æ•°æ®é›†èƒ½å¤Ÿè¢«å°æ¨¡å‹ç†è§£ï¼Œä½¿ç”¨äº†ä¸‰ä¸ªagentç»„æˆçš„æ™ºèƒ½ä½“
5. å¯¹ä¸¤ç±»æ•°æ®é›†è¿›è¡Œç»¼åˆï¼Œå¹¶åˆ©ç”¨LoRAè¿›è¡Œè®­ç»ƒ

æœ€ç»ˆè·å¾—çš„æ•°æ®é›†åº”è¯¥æ˜¯ï¼š

BadcaseQA+FinQA+deepseekR1è’¸é¦æ•°æ®

ä¸ºäº†è§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜

æŠŠbadcaseæ‹¿å‡ºæ¥äººå·¥æ ‡æ³¨+æ··åˆé‡‘èè§£é‡Šç±»QAæ•°æ®é›†finqaåšå†…å®¹ç†è§£ç»„æˆä¸€éƒ¨åˆ†æ•°æ®é›†

ä¸ºäº†è§£å†³ç¬¬äºŒä¸ªé—®é¢˜ï¼š

è¿™é‡Œæ¨¡å‹è’¸é¦ç®—æ˜¯æ¯”è¾ƒå¤æ‚çš„ä¸€ä¸ªè¿‡ç¨‹

#### æ¨¡å‹è’¸é¦
åˆ†ä¸ºé»‘ç›’è’¸é¦å’Œç™½ç›’è’¸é¦ï¼Œé»‘ç›’è’¸é¦å°±æ˜¯ç›´æ¥æŠŠæ•°æ®è’¸é¦å‡ºæ¥ä¹‹åå¯¹å­¦ç”Ÿæ¨¡å‹è¿›è¡Œè®­ç»ƒ

ç™½ç›’è’¸é¦æ˜¯æŠŠæ•™å¸ˆæ¨¡å‹çš„softmaxåˆ†å¸ƒæ‹¿å‡ºæ¥å’Œå­¦ç”Ÿæ¨¡å‹çš„ç®—lossã€‚

å…¶ä¸­é»‘ç›’è’¸é¦çš„æ•°æ®å«åšç¡¬æ ‡ç­¾ï¼Œç™½ç›’è’¸é¦å«åšè½¯æ ‡ç­¾ã€‚

##### ç™½ç›’è’¸é¦
ç™½ç›’è’¸é¦çš„losså¦‚ä¸‹å›¾æ‰€ç¤º

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1760668833175-11e79d7d-04be-42f4-a9de-184ca26edd83.png)

å¯ä»¥çœ‹å‡ºæ¥å°±æ˜¯ä¸€ä¸ªå¸¦æ¸©åº¦ç³»æ•°çš„KLæ•£åº¦ï¼Œè¿™é‡Œçš„Tæ˜¯ä¸ºäº†æŠµæ¶ˆæ•™å¸ˆæ¨¡å‹çš„æ¸©åº¦ç³»æ•°ç¼©æ”¾

å…¶åˆ†å¸ƒpå°±æ˜¯æ•™å¸ˆæ¨¡å‹çš„æ¦‚ç‡åˆ†å¸ƒï¼Œä¹Ÿå°±æ˜¯æ•™å¸ˆæ¨¡å‹çš„softmax

 æ€è·¯ï¼šæ‰“ç®—ç”¨å…ˆå‰æ­å»ºçš„ **RAG + DeepseekR1è’¸é¦** æ¥ç”Ÿæˆè·¨æ–‡æ¡£æ¨ç†å‹QAæ•°æ®  ï¼ŒåŒæ—¶ä¸ºäº†ç”Ÿæˆçš„å‡†ç¡®æ€§å’Œæ¨ç†çš„å®Œæ•´æ€§ï¼Œå¤§æ¦‚æ•°æ®é›†æ•´ç†æµç¨‹å¦‚ä¸‹ï¼š

1. å…ˆæ•´ç†å‡ºé—®é¢˜
2. è¿›è¡ŒRAGæ£€ç´¢ï¼Œå•æ¡æ£€ç´¢ç»“æœå¯èƒ½ä¸å¤Ÿï¼Œè¦ä¿ç•™ Top-K (å¦‚5â€“10æ¡) ç›¸å…³ç‰‡æ®µç»™æ¨¡å‹æ•´åˆã€‚
3. è®¾ç½®promptï¼Œè¾“å…¥deepseekR1ï¼Œæ ¹æ®RAGæ£€ç´¢åˆ°çš„å†…å®¹å’Œé—®é¢˜ç”Ÿæˆcotå’Œç­”æ¡ˆ

ä¸‹é¢å…·ä½“è¯´ä¸€ä¸‹æ¯ä¸€ä¸ªçš„è¯¦ç»†æ­¥éª¤ï¼š

å…ˆè¯´æ•´ç†é—®é¢˜

æ ¹æ®badcaseæ•´ç†å‡ºé—®é¢˜æ¨¡æ¿ï¼Œå¹¶æ›¿æ¢å…³é”®è¯è¿›è¡Œé‡æ–°ç”Ÿæˆ

+ â€œä¸ºä»€ä¹ˆXæŒ‡æ ‡åœ¨2023å¹´å‡ºç°å˜åŒ–ï¼Ÿâ€
+ â€œå¯¼è‡´Yä¸‹é™çš„ä¸»è¦åŸå› æ˜¯ä»€ä¹ˆï¼Ÿâ€
+ â€œ2023å¹´zå…¬å¸çš„ç°é‡‘æµä¸å‡€åˆ©æ¶¦å·®å¼‚çš„åŸå› ï¼Ÿâ€

 è‡ªåŠ¨æ›¿æ¢è´¢åŠ¡æŒ‡æ ‡åç§°å’Œå¹´ä»½ç”Ÿæˆå¤§é‡å€™é€‰é—®é¢˜ã€‚  

åŒæ—¶æ··äº†ä¸€äº›å¯¹è¯çš„æ ·æœ¬ä»R1è’¸é¦å‡ºæ€ç»´é“¾è¿›è¡Œå­¦ä¹  ï¼Œè¿™ä¸ªéƒ¨åˆ†åˆ°æ²¡æœ‰ç”¨RAG





æ¥ä¸‹æ¥è¯¦ç»†å¯¹æ•´ä¸ªæµç¨‹ï¼Œç»†èŠ‚è¯¦ç»†è¯´æ˜ã€‚

å…·ä½“çš„è’¸é¦promptå¦‚ä¸‹ï¼š

1. å…ˆæŸ¥çœ‹è¯æ®ï¼Œä¹‹åæ’é™¤è¯æ®ï¼Œå†³å®šå“ªäº›å¯¹è¿™ä¸ªæ¨¡å‹æœ‰ç”¨å“ªäº›æ²¡ç”¨ï¼Œ 
2. ä¹‹ååˆ©ç”¨å·²æœ‰æ•°æ®ç”Ÿæˆç­”æ¡ˆ 
3. æ ¡éªŒï¼šç­”æ¡ˆä¸­å¦‚æœåŒ…å«æ•°å­—ï¼Œå¿…é¡»å’Œæ£€ç´¢åˆ°çš„æ•°å­—ä¸€è‡´







#### ä¸ºä»€ä¹ˆä¸ç”¨CPT?æ²¡åšCPTç›´æ¥ä½¿ç”¨SFTå¯¹æ¯”æµ‹è¯•è¿‡å—ï¼Ÿ
### RAGæ•°æ®ç›¸å…³ï¼š
#### RAGæ•°æ®é›†æ€ä¹ˆæ„å»ºçš„ï¼Œæ•°æ®é‡çš„è§„æ¨¡ï¼Œæœ‰æ ‡æ³¨å—ï¼Ÿ
RAGæ•°æ®çš„åŸå§‹æ•°æ®æ˜¯

ç”±10000å¤šä¸ªå…¬å¸è´¢æŠ¥ç»„æˆçš„pdf 60å¤šG

å’Œ1wæ¡çš„QAæ•°æ®é›†

é¦–å…ˆè¦æ£€ç´¢çš„PDFæ•°æ®æ„å»ºä¸ºæ–‡æ¡£æ ‘

åŒæ—¶åœ¨çº¿æœç´¢æ¥è¡¥é½çŸ¥è¯†

##### PDFå¦‚ä½•è¯»å–çš„ï¼Ÿå‡†ç¡®ç‡å¦‚ä½•ï¼Œæ€ä¹ˆè¯„ä¼°çš„ï¼Ÿ
##### æ–‡æ¡£æ ‘å…·ä½“æ˜¯æ€ä¹ˆæ„å»ºçš„ï¼Ÿ
##### æœ€åå­˜å‚¨åœ¨Faissæ•°æ®åº“å’Œsqliteæ•°æ®åº“ä¸­çš„æµç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ
#### QAæ•°æ®æ ¼å¼æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ
### RAGæŠ€æœ¯é€‰å‹ç›¸å…³
#### å‘é‡åŒ–æ¨¡å‹é€‰æ‹©çš„åŸå› ï¼Œæœ‰æ²¡æœ‰è¿›è¡Œæ¨ªå‘å¯¹æ¯”ï¼Œå¦‚ä½•å¯¹æ¯”çš„ï¼Ÿ
[https://huggingface.co/spaces/mteb/leaderboard](https://huggingface.co/spaces/mteb/leaderboard)

é€šè¿‡è¿™ä¸ªå»é€‰å‹ï¼Œä¸€èˆ¬ç”¨é…å¥—ï¼Œé€‰bgeä¸»è¦æ˜¯ç”¨çš„äººå¾ˆå¤šï¼Œå¯ä»¥å…·ä½“æŸ¥ä¸€æŸ¥ç†ç”±ã€‚

å¯ä»¥åšä¸€ä¸ªæ¨¡å‹è¯„ä¼°ã€‚ä¹Ÿå¯ä»¥å¾®è°ƒ

æ³¨æ„ç»´åº¦ä¹‹ç±»çš„æ˜¯å¦ä¸€è‡´

[https://blog.csdn.net/xiangxiang613/article/details/143562648](https://blog.csdn.net/xiangxiang613/article/details/143562648)

#### å‘é‡æ•°æ®åº“ï¼Ÿ
### RAGæŠ€æœ¯ç»†èŠ‚
#### æ•´ä¸ªRAGé“¾è·¯ä»‹ç»ä¸€ä¸‹ï¼š
é¦–å…ˆå¯¹æ•°æ®é›†è¿›è¡Œ

å®ç°inexing,embeddingè¿‡ç¨‹ä¹‹åï¼ŒæŠŠæ‰€è·å¾—çš„å‘é‡å­˜åˆ°Faissæ•°æ®åº“å½“ä¸­ã€‚

åšäº›å‡†å¤‡å·¥ä½œï¼šç¬¬ä¸€æ­¥å…ˆå»ºè¡¨ï¼Œä¸è¿‡æ˜¯æ˜ å°„åŸå§‹ä¿¡æ¯å’Œchunkä¹‹é—´å…³ç³»çš„ä¸‰ä¸ªè¡¨

åˆ†åˆ«ä»£è¡¨äº†åŸå§‹æ–‡ä»¶ï¼Œå‘é‡æ•°æ®åº“çš„ä¿¡æ¯ï¼Œå’Œå¯¹åº”çš„ä¿¡æ¯

ç¬¬ä¸€ä¸ªè¡¨æ˜¯å‘é‡åº“åŸºç¡€é…ç½®ä¿¡æ¯ã€‚

+ çŸ¥è¯†åº“çš„åç§°
+ çŸ¥è¯†åº“çš„ç®€ä»‹
+ ä½¿ç”¨çš„æ˜¯ä»€ä¹ˆå‘é‡åº“
+ ä½¿ç”¨çš„æ˜¯ä»€ä¹ˆembeddingæ¨¡å‹
+ ç”¨æˆ·id

ç¬¬äºŒä¸ªè¡¨æ˜¯å…³äºæºæ–‡ä»¶ç›¸å…³çš„

+ æ–‡ä»¶å
+ æ–‡ä»¶æ‰©å±•å
+ æ–‡ä»¶ç‰ˆæœ¬
+ æ–‡ä»¶ä¿®æ”¹æ—¶é—´
+ æ–‡ä»¶å¤§å°
+ æ–‡æ¡£åŠ è½½å™¨
+ æ–‡æ¡£åˆ†å‰²å™¨
+ åˆ†å‰²äº†å¤šå°‘æ–‡æ¡£

ç¬¬ä¸‰ä¸ªè¡¨æ˜¯æ–‡ä»¶å’Œå‘é‡åº“çš„å¯¹åº”id

+ å±äºå“ªä¸ªçŸ¥è¯†åº“
+ æ–‡ä»¶åæ˜¯ä»€ä¹ˆ
+ å¯¹åº”çš„å‘é‡åº“idæ˜¯ä»€ä¹ˆ

æ˜¯é€šè¿‡SQLAlchemå»å°†pythonå’ŒSQLæ•°æ®åº“è¿›è¡Œé“¾æ¥ï¼Œå®ç°äº†å‘é‡åº“æ‰€éœ€è¦çš„databaseï¼Œåº”è¯¥ä¼šæŠŠè¿™ä¸‰ä¸ªè¡¨è¿èµ·æ¥ï¼Œä½†æ˜¯å…·ä½“è¿™ä¸‰ä¸ªè¡¨æœ‰å•¥ç”¨å‘¢ï¼Ÿ

ä¹‹ååˆ›å»ºFaissæ•°æ®åº“çš„åŸºç±»ã€‚

åŒ…å«äº†åˆ›å»ºFaissæ•°æ®åº“ç´¢è¦çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬äº†embeddingæ¨¡å‹ï¼Œ

è¿˜åŒ…å«äº†ä¸€äº›åŸºæœ¬æ–¹æ³•ï¼Œåˆ›å»ºæ•°æ®åº“å•Šï¼Œå¢åˆ æ”¹æŸ¥å•Š

ä¹‹ååˆ›å»ºäº†å…·ä½“faissçš„æœåŠ¡ç±»ï¼Œå¹¶ç»§æ‰¿åŸºç±»ï¼Œåšä¸€äº›å…·ä½“çš„å¤„ç†ï¼Œå¤§æ¦‚ä¹Ÿæ˜¯çŸ¥è¯†åº“å’Œæ•°æ®åº“ä¹‹é—´çš„ä¸€äº›æ“ä½œ

åœ¨ä½¿ç”¨Faissæ•°æ®åº“çš„æ—¶å€™ï¼Œä¼ å…¥å‚æ•°ï¼Œè‡ªåŠ¨è°ƒç”¨ç»§æ‰¿äº†baseç±»çš„faissæœåŠ¡ç±»ã€‚

å®ä¾‹åŒ–ä¹‹åï¼Œä¼ å…¥KBä¸­çš„å‚æ•°ï¼ˆæ–‡ä»¶åä¹‹ç±»çš„ï¼‰å°±å¯ä»¥åœ¨å‘é‡åº“ä¸­å®ç°indexçš„æ·»åŠ äº†ã€‚

å…·ä½“çš„ç»†èŠ‚æ˜¯å…ˆåˆ†è¾“å…¥çš„ç±»å‹ï¼Œé€‰æ‹©ä¸åŒçš„ç±»å‹è¿›è¡Œembeddingã€‚å¹¶å­˜å‚¨åˆ°æ•°æ®åº“å½“ä¸­

å…·ä½“ç»†èŠ‚æ„Ÿè§‰å¾ˆå¤šå·¥ç¨‹åŒ–çš„ä¸œè¥¿ï¼Œåˆ‡åˆ†æ–¹æ³•å°±æ˜¯recuåˆ‡åˆ†æ³•ã€‚

åœ¨æ‰§è¡Œäº†ä¸Šè¿°ç‚’ä½œä¹‹åï¼Œå®ç°äº†å‘é‡æ•°æ®åº“faissçš„æ•°æ®å­˜å‚¨ï¼Œå¹¶åŒæ­¥åˆ°ä¸‰ä¸ªè¡¨å½“ä¸­

ä¸‹é¢çš„è¡¨æ˜¯å‘é‡æ•°æ®åº“çš„ä¸»è¦ä¿¡æ¯ï¼Œæ–‡ä»¶åå¯¹åº”çš„chunkid

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759919702432-7d01b27a-d1f2-4ae8-89fa-69a97ca18927.png)

ä¸‹é¢è¿™ä¸ªè¡¨æ˜¯çŸ¥è¯†åº“ä¸­fileçš„ä¿¡æ¯

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759919731554-f412c9b3-4f7b-42e7-a0bf-c82d6576eb8a.png)

è¿˜æœ‰å‘é‡æ•°æ®åº“çš„åŸºæœ¬ä¿¡æ¯

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759919814586-c84525c7-63b8-405d-8c5d-aaaf520cdb1f.png)

ä¹‹åå…¥è‚¡æœ‰å‰ç«¯çš„postç»è¿‡api_routeè¿™ä¸ªè¿‡ç¨‹è·¯ç”±åˆ°å½“å‰çš„æ–¹æ³•å½“ä¸­ã€‚



#### indexingè¿‡ç¨‹
##### æ–‡æœ¬å¦‚ä½•è¿‡æ»¤ï¼Ÿ
å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759720653761-fdbfbf71-5d16-4829-8840-d30ca03e540b.png)                    

é¦–å…ˆä½¿ç”¨wikiè‡ªå¸¦çš„åŒ…wikiext..å»æå–æ–‡ä»¶ä¸ºjson

jsonå¤§æ¦‚å°±æ˜¯titleå’Œå¯¹åº”çš„text

ä¹‹åç­›é€‰å‡ºç¬¦åˆå…³é”®è¯çš„textä½œä¸ºå¤–æ¥è¯­æ–™åº“åŸºç¡€æ•°æ®

å¯¹åŸºç¡€æ•°æ®è¿›è¡Œsplitï¼Œæ¯ä»½å¹¶é€å…¥å¤šçº¿ç¨‹å¤„slç†å™¨Poolå¤„ç†![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759722174191-5061e543-bbca-4e0e-bd24-9f90f6b4a5d4.png)

```plain
def single_worker(docs):
    """
    å¤„ç†ä¸€ä¸ªæ–‡æ¡£åˆ—è¡¨ï¼Œå¯¹æ¯ä¸ªæ–‡æ¡£åº”ç”¨æ¸…æ´—å’Œæ ¼å¼åŒ–æ“ä½œã€‚
    """
    # åˆå§‹åŒ–ç»“æœåˆ—è¡¨ï¼Œç”¨äºå­˜å‚¨å¤„ç†åçš„æ–‡æ¡£
    results = []
    # éå†æ–‡æ¡£åˆ—è¡¨ï¼Œä½¿ç”¨ tqdm åº“æ˜¾ç¤ºè¿›åº¦æ¡
    for item in tqdm(docs):
        # åº”ç”¨åŸºç¡€å¤„ç†å‡½æ•° basic_process æ¥å¤„ç†æ¯ä¸ªæ–‡æ¡£çš„æ ‡é¢˜å’Œæ–‡æœ¬
        title, text = basic_process(item[0], item[1])
        # å¦‚æœå¤„ç†åçš„æ ‡é¢˜æ˜¯ Noneï¼ˆå¯èƒ½å› ä¸ºæ–‡æ¡£ä¸ç¬¦åˆå¤„ç†è¦æ±‚ï¼‰ï¼Œåˆ™è·³è¿‡å½“å‰å¾ªç¯
        if title is None:
            continue
        # æ ¼å¼åŒ–æ ‡é¢˜ï¼ŒåŠ ä¸ŠåŒå¼•å·
        title = f"\"{title}\""
        # å°†å¤„ç†å’Œæ ¼å¼åŒ–åçš„æ ‡é¢˜å’Œæ–‡æœ¬ä»¥å…ƒç»„å½¢å¼æ·»åŠ åˆ°ç»“æœåˆ—è¡¨ä¸­
        results.append((title, text))
    return results
```

å¤„ç†çš„æ–¹å¼æ˜¯é€šè¿‡ä¸€äº›æ­£åˆ™åŒ–çš„æ‰‹æ®µå»å»é™¤ï¼Œè¯¦è§å›¾ç‰‡å§

###### æ­£åˆ™è¡¨è¾¾å¼ï¼Ÿ
##### ä¸ºä»€ä¹ˆä¸ç”¨ç¦»çº¿æ•°æ®åº“ï¼Ÿ
ä¹‹å‰æœ‰æƒ³æ³•ä½¿ç”¨wikiæ•°æ®å­˜å‚¨åˆ°æ•°æ®åº“ä¸­è¿›è¡Œæ„å»ºä¸€ä¸ª

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759717797567-53c93e17-4d4f-4d04-b574-7bae55b89b50.png)

è¾ƒå¤§çš„æ•°æ®åº“è¿›è¡Œæ£€ç´¢å¬å›ï¼Œæ¥å¼¥è¡¥æ¨¡å‹å’Œå½“å‰æ—¶é—´çš„çŸ¥è¯†å·®è·ï¼Œä½†æ˜¯å¯¹å“åº”æœ‰è¦æ±‚ï¼Œè€Œä¸”ä½¿ç”¨ç»´åŸºç™¾ç§‘éœ€è¦ç§‘å­¦ä¸Šç½‘ï¼Œæœ‰äº›æ•æ„Ÿå†…å®¹ä¸‡ä¸€æ²¡æœ‰æ¸…æ´—æ‰éå¸¸éº»çƒ¦ã€‚æ‰€ä»¥ä½¿ç”¨bingè”ç½‘æŸ¥è¯¢

##### æœ‰å“ªäº›chunkè¿‡ç¨‹ï¼Œå¦‚ä½•åˆ‡chunkçš„ï¼Ÿ
ä½¿ç”¨recuive è¿‡ç¨‹ï¼Œç¢°åˆ°ã€\n\nå¹¶ä¸”æ²¡åˆ°ä¸€ç™¾å­—ç¬¦å°±ç»§ç»­æŒ‰ç…§æ–°çš„ è§„åˆ™åˆ‡åˆ†ï¼Œæ¯”å¦‚è¯´\n

å¦‚æœ

å¯¹äºæ–‡æœ¬ä¿¡æ¯ï¼Œå¯ä»¥ç”¨\nï¼Œ ç©ºæ ¼ç­‰ç‰¹æ®Šå­—ç¬¦å»åˆ‡åˆ†ã€‚ç›´åˆ°å°äº100ä¸ºæ­¢

åŒæ—¶ä¹Ÿä¿ç•™ä¸€å®šçš„Overlapï¼Œï¼ˆchunk1000ï¼Œ200overlapï¼‰ä¿è¯è¯­ä¹‰ä¸ä¼šæ–­çš„å¤ªå‰å®³

ä¹Ÿå¯ä»¥ç”¨spacyå»åˆ‡åˆ†chunkï¼Œä½¿ç”¨spaCyçš„pipeæ–¹æ³•å»è¯­ä¹‰åˆ‡åˆ†

##### 
##### chunkçš„æ•°æ®æ ¼å¼ä»€ä¹ˆæ ·çš„ï¼Ÿ
page contentå†…å®¹ï¼Œå¯¹åº”çš„metadataï¼Œ chunkæ˜¯ä»€ä¹ˆå¯¹è±¡ï¼ŒåŸºæœ¬ä¿¡æ¯ 

#### embeddingè¿‡ç¨‹ï¼š
##### langchainæ˜¯å¦‚ä½•è¿›è¡Œembeddingçš„ï¼Ÿ


##### embeding modelæ˜¯æ€ä¹ˆé€‰çš„ï¼Ÿå¦‚ä½•å¯¹æ¯”çš„ï¼Ÿ
é¦–å…ˆä¼˜å…ˆé€‰é…å¥—çš„æ¨¡å‹

#### è”ç½‘æŸ¥è¯¢
##### å…·ä½“æ€ä¹ˆå®ç°çš„ï¼Œæµç¨‹ä»‹ç»ä¸€ä¸‹ï¼š
![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759810572898-9a21af62-538b-417f-8696-2b5ca6d2d8cc.png)

å…ˆåŠ è½½åŸå§‹æ–‡æ¡£ä¹‹åç”¨splitterå»åˆ‡åˆ†ä¹˜chunkï¼Œsplit_documentæ–¹æ³•è½¬æ¢æˆdocumentsæ•°æ®

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759809184560-4be8b58f-98ae-4ac7-9a89-3d402570611d.png)

ä¹‹ååˆ›å»ºæ•°æ®åº“ï¼Œæ¯”å¦‚è¯´chromaè¿™ä¸ªæ•°æ®åº“ï¼Œé¦–å…ˆè¡¨åç§°ï¼Œä½¿ç”¨çš„embedingæ¨¡å‹ï¼ˆqueryä¹Ÿéœ€è¦ç»è¿‡embeddingï¼‰è¿™ç±»åŸºæœ¬ä¿¡æ¯

ä¹‹åæŠŠtextsï¼ˆdocument)æ•°æ®åˆ©ç”¨add_textså­˜å‚¨å³å¯

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759810243302-2ccb0cde-0aa1-4ff7-9d13-5755f5d02f3f.png)

åˆ°è¿™é‡Œindexingè¿‡ç¨‹å°±å®ç°å¥½äº†

åŒæ—¶retriveråˆ©ç”¨chroma_storeå‘é‡åº“å»åˆ›å»ºï¼Œç›´æ¥å¯ä»¥è¿›è¡Œæ£€ç´¢

langchain hubé‡Œæ‹‰å»ä¸€ä¸ªpromptï¼Œä½œä¸ºRAGretriverè¿‡ç¨‹çš„promptè¿›è¡Œè¾“å…¥

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759810367898-c5613e2c-8469-40be-ae1a-104eccd8a85d.png)

ä¹‹åç”¨è¯­æ³•ç³–æŠŠå…³é”®ç»„ä»¶ä¸²è”åœ¨ä¸€èµ·

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759810823265-e893b1df-3b46-464c-b54b-6255e35f933f.png)

æ‹¿åˆ°retriveræ£€ç´¢çš„å†…å®¹ï¼Œä¹‹åç»è¿‡ç®€å•æ ¼å¼åŒ–ï¼ŒåŒäº‹å’Œquersionï¼ˆRunnablePassthroughæ˜¯langchainçš„ä¸€ä¸ªæ–¹æ³•ï¼Œå¤§æ¦‚æ„æ€æ˜¯ç›´æ¥ç”±ç”¨æˆ·ä¼ å…¥é—®é¢˜ï¼Œè¿™ä¸ªéœ€è¦æ˜¾ç¤ºè¾“å…¥ï¼Œè›‹æ²¡æœ‰ç”¨è¿™ä¸ªå˜é‡æ ‡è¯†ä¹Ÿä¸ä»£è¡¨ä¸éœ€è¦ï¼‰

å’Œpromptå’Œchatï¼Œä¸²è”åˆ°ä¸€èµ·ï¼Œæœ€åé€šè¿‡è¾“å‡ºè§£æå™¨è§£æ

#### RAGå¬å›ç­–ç•¥æ€ä¹ˆè®¾è®¡çš„ï¼Ÿ
#### Redisçš„ç¼“å­˜æ€ä¹ˆå®ç°çš„ï¼Ÿ
#### SQLite/Fassisæ€ä¹ˆåšçš„ ï¼Ÿ
##### ä¸ºä»€ä¹ˆè¦é€‰æ‹©Faisså‘é‡æ•°æ®åº“ï¼Ÿ
é¦–å…ˆæœ‰chromaï¼ŒElasticSearchï¼ŒFaissï¼ŒMilvus

#### å¦‚ä½•å®ç°é•¿æœŸå­˜å‚¨ï¼Ÿ	
é¦–å…ˆå†å²çš„ä¿¡æ¯é€šè¿‡promptå·¥ç¨‹å¤„ç†é‡æ„æˆä¸€æ®µç²¾ç®€çš„ï¼Œå¤§æ¨¡å‹å¯ä»¥ç†è§£çš„å¯¹è¯ï¼Œä¹‹åå°†QAé‡æ–°è¾“å…¥åˆ°å¤§æ¨¡å‹å½“ä¸­å…·ä½“ä½¿ç”¨langchainçš„è¿‡ç¨‹å¦‚ä¸‹

é¦–å…ˆç»„åˆæˆä¸€ä¸ªpromptä¿¡æ¯

```plain
contextualize_q_prompt = ChatPromptTemplate.from_messages(
    [
        ("system", contextualize_q_system_prompt),
        MessagesPlaceholder("chat_history"),
        ("human", "{input}"),
    ]
)
```

åœ¨è°ƒç”¨çš„æ—¶å€™invokeå°±æ˜¯è¾“å…¥åˆ°è¿™ä¸ªå½“ä¸­

ä¹‹åå°†è¿™ä¸ªpromptåˆ›å»ºä¸€ä¸ªretriver

```plain
retriever = chroma_store.as_retriever()

history_aware_retriever = create_history_aware_retriever(chat,
                                                         retriever,
                                                         contextualize_q_prompt
)

```

æœ€åå†å°†ä¸¤ä¸ªæ£€ç´¢å™¨chainåˆ°ä¸€èµ·ï¼š

```plain
rag_chain = create_retrieval_chain(history_aware_retriever, question_answer_chain)
```

ä¹‹ååœ¨æ‰§è¡Œè¾“å…¥çš„æ—¶å€™ï¼Œé€šè¿‡ChatMessHisæ–¹æ³•å»è·å–å½“å‰å¯¹è¯ï¼Œå¹¶ç»´æŠ¤å­—å…¸å½¢æˆå†å²å¯¹è¯

å¹¶é€šè¿‡Runnableã€‚ã€‚ã€‚å»è°ƒç”¨runnableï¼Œå†å²ä¿¡æ¯ç­‰

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759897579435-7e96903a-c464-4158-a96f-b3b471425ebc.png)

å®Œæ•´çš„ä¿¡æ¯å†å²

```python
def get_session_history(session_id: str) -> BaseChatMessageHistory:
    if session_id not in store:
        store[session_id] = ChatMessageHistory()
    return store[session_id]

# å®˜æ–¹Docsï¼šhttps://python.langchain.com/v0.2/docs/how_to/message_history/
conversational_rag_chain = RunnableWithMessageHistory(
    rag_chain,
    get_session_history,
    input_messages_key="input",
    history_messages_key="chat_history",
    output_messages_key="answer",
)

# ç°åœ¨æˆ‘ä»¬é—®ç¬¬ä¸€ä¸ªé—®é¢˜
first_ans = conversational_rag_chain.invoke(
    {"input": "What is Task Decomposition?"},
    config={
        "configurable": {"session_id": "abc123"}
    },
)["answer"]


secone_ans = conversational_rag_chain.invoke(
    {"input": "What are common ways of doing it?"},
    config={"configurable": {"session_id": "abc123"}},
)["answer"]
```

åˆšåˆšä»‹ç»çš„æ˜¯å°†ChatMessageHistory()è¿™ä¸ªå‡½æ•°æ˜¯ä»ç¼“å­˜ä¸­ç›´æ¥è·å–çš„å¯¹è¯ä¿¡æ¯ï¼Œè¿˜æ²¡æœ‰åŠæ³•åšåˆ°æŒä¹…åŒ–å­˜å‚¨

æ‰€ä»¥ç°åœ¨è¦æŠŠå¯¹è¯æŒä¹…åŒ–å­˜å‚¨åˆ°sqliteå½“ä¸­

SQLAIChemyåŒ…å»æŒä¹…åŒ–å­˜å‚¨åˆ°SQLå½“ä¸­ï¼Œè¿›è¡Œå¢åˆ æ”¹æŸ¥

é¦–å…ˆå»ºè¡¨é€šè¿‡ç»§æ‰¿baseç±»ç›´æ¥åˆ›å»ºç±»ï¼Œé‡Œé¢çš„å­—æ®µå°±æ˜¯æ•°æ®åˆ—

åˆ›å»ºå¹¶è¿è¡¨çš„è¿‡ç¨‹

```python
# Step 3. å®šä¹‰å¯ä»¥ä½¿ç”¨Baseç±»ç®¡ç†çš„æ¨¡å‹ç±»
class Session(Base):
    """
    Session ç±»è¡¨ç¤ºèŠå¤©ä¼šè¯
    """
    __tablename__ = "sessions"
    id = Column(Integer, primary_key=True)
    session_id = Column(String, unique=True, nullable=False)
    messages = relationship("Message", back_populates="session")


class Message(Base):
    """
    Message ç±»è¡¨ç¤ºä¼šè¯ä¸­çš„å„ä¸ªæ¶ˆæ¯
    """
    __tablename__ = "messages"
    id = Column(Integer, primary_key=True)
    session_id = Column(Integer, ForeignKey("sessions.id"), nullable=False)
    role = Column(String, nullable=False)
    content = Column(Text, nullable=False)
    session = relationship("Session", back_populates="messages")



```

ä¹‹å‰æ˜¯åœ¨pythonä¸­æŠ½è±¡çš„åˆ›å»ºï¼Œç°åœ¨ä½¿ç”¨create-engineåœ¨ç¡¬ç›˜ä¸­åˆ›å»ºå®é™…çš„è¡¨ï¼Œå¹¶å»ºç«‹èµ·è”ç³»

```python
    # Step 2. å®šä¹‰ SQLite æ•°æ®åº“ä»¥åŠç”¨äºå­˜å‚¨ä¼šè¯å’Œæ¶ˆæ¯çš„æ¨¡å‹ã€‚
    DATABASE_URL = "sqlite:///chat_history.db"


    # Step 3. åˆ›å»ºæ¨¡å‹ç±». å®˜ç½‘ï¼šhttps://docs.sqlalchemy.org/en/20/orm/quickstart.html
    engine = create_engine(DATABASE_URL)
    Base.metadata.create_all(engine)
```

ä¹‹åé€šè¿‡sessionmakerç®¡ç†ä¸SQLä¹‹é—´çš„ä¼šè¯

```python
    # Step 4. æ„å»ºSession æ¥ç®¡ç†ä¼šè¯ã€‚å®˜æ–¹Docsï¼šhttps://docs.sqlalchemy.org/en/20/orm/session_basics.html
    SessionLocal = sessionmaker(bind=engine)
```

ä¹‹ååˆ›å»ºæ–¹æ³•å®ç°å¯¹æ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥

å®é™…ä¸Šçš„sessionåˆ›å»ºæ—¶è¦å¼‚æ­¥åˆ›å»ºçš„ï¼Œæ•°æ®åº“ä¹Ÿæ˜¯

### RAGåœºæ™¯é—®é¢˜ï¼š
#### å¦‚ä½•æ£€ç´¢æ°´æµ’ä¼ ä¸­è°æ˜¯è°çš„è°
### RAGæŠ€æœ¯è¯„ä¼°
RAGè¯„ä¼°é¦–å…ˆæœ€éœ€è¦çš„å°±æ˜¯testæ•°æ®é›†ï¼Œè·å¾—ä¸äº†çš„è¯æœ‰

![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759924845796-c28b55b0-015e-4ed6-9dd7-4c7fafbb1090.png)

å…·ä½“æ“ä½œæ–¹æ³•å°±æ˜¯å†™promptä¸¢ç»™å¤§æ¨¡å‹

### å¾®è°ƒæ•°æ®ç›¸å…³
#### æ•°æ®æ€ä¹ˆæ”¶é›†çš„ï¼Ÿæ¸…æ´—çš„æ‰‹æ®µï¼Ÿ
é¦–å…ˆå› ä¸ºè¦æé«˜å›ç­”çš„é€»è¾‘èƒ½åŠ›ï¼Œé¦–å…ˆæ•°æ®æ¥æºäºè¯­éŸ³ï¼Œéœ€è¦é¦–å…ˆå¯¹è¯­éŸ³è¿›è¡Œå¤„ç†ï¼Œæå–æ–‡å­—ï¼Œå¹¶åšå»é‡

å…¶æ¬¡ä¸ºäº†æé«˜RAGéƒ¨åˆ†çš„å‡†ç¡®åº¦ï¼Œéœ€è¦è¿›è¡Œè¦ç´ è¯†åˆ«è¿™ä¸ªä»»åŠ¡ï¼Œæ•°æ®ä¸­æ··åˆäº†NLPå…¬å¼€æ•°æ®é›†å¯¹è¦ç´ è¯†åˆ«è¿™ä¸ªéƒ¨åˆ†è¿›è¡Œäº†å¾®è°ƒï¼Œå‡†ç¡®åº¦è¾¾99.2%ï¼Œ ![](https://cdn.nlark.com/yuque/0/2025/png/43288584/1759812398642-bf45d55b-420f-42f2-b7c7-e330c9eb62ad.png)

(ä¸Šè¿°çš„è¿‡ç¨‹ç±»ä¼¼äºå¯¹é—®é¢˜åšäº†åˆ†ç±»ï¼‰

é¦–å…ˆfewshotçš„æ­£ç¡®ç‡ä¸æ˜¯ç™¾åˆ†ç™¾ï¼Œä¸ºäº†æç‚¹å°±æŠŠbadcaseæ‹¿å‡ºæ¥é‡æ–°è¿›è¡Œäººå·¥æ ‡æ³¨ï¼Œå¹¶ç”¨LoRAå¯¹æ•°æ®è¿›è¡Œé‡æ–°å¾®è°ƒï¼Œæœ€åè®©å‡†ç¡®ç‡å˜é«˜

#### æœ‰æ²¡æœ‰å¯¹æ¯”æ¸…æ´—çš„ä¸åŒå¯¼è‡´çš„å·®å¼‚ï¼Ÿ
#### æ•°æ®é›†å¦‚ä½•æ„é€ çš„ï¼Œé…æ¯”å¦‚ä½•ï¼Ÿ
#### å…·ä½“æ•°æ®æ ¼å¼æ˜¯ä»€ä¹ˆæ ·çš„ï¼š
è¯­éŸ³æ•°æ®æ ¼å¼æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿè§£æå¥½çš„å¯¹è¯æ•°æ®æ ¼å¼æ˜¯ä»€ä¹ˆæ ·çš„ï¼Œlabelæ˜¯ä»€ä¹ˆï¼Œæ€ä¹ˆå¤„ç†æˆalpaca/sharegptæ ¼å¼çš„ï¼Ÿ

#### ä½ è¿™æ ·çš„é…æ¯”æ˜¯å¦‚ä½•è€ƒè™‘å¤šæ ·æ€§çš„ï¼Ÿä¼šä¸ä¼šä»…ä»…é€¼è¿‘æ•°æ®åˆ†å¸ƒæƒ…å†µï¼Œåœ¨ä¸åŒéƒ¨åˆ†æ¨¡å‹å¢å¼ºï¼Œbenchmarkä¸Šå´åœ¨å‡å¼±ï¼Œå¯¼è‡´è¯„ä¼°ä¸å‡†çš„æƒ…å†µï¼Ÿ
#### å¦‚ä½•åªæœ‰ä¸“æœ‰é¢†åŸŸæ•°æ®çš„è¯ï¼Œä¼šä¸ä¼šå‡ºç°é€šç”¨æƒ…å†µå¾ˆå¼±çš„ï¼Ÿéœ€è¦è§£å†³å—ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ
### å¾®è°ƒé€‰å‹å±‚é¢
#### ä»‹ç»ä¸‹Qwen2.5æ¨¡å‹æ¶æ„
ä½¿ç”¨çš„14bçš„Qwen2.5

#### å¯¹æ¯”ä¸åŒæ¨¡å‹ï¼Œä¸ºä»€ä¹ˆæœ€åé€‰æ‹©äº†Qwen2.5ä½œä¸ºæ¨¡å‹ï¼ŒQwen2.5å¾®è°ƒèµ·æ¥æœ‰ä»€ä¹ˆç‰¹æ®Šçš„åœ°æ–¹å—ï¼Ÿ
#### æ¨¡å‹å¤§å°å‚æ•°æœ‰ä»€ä¹ˆè®²ç©¶ï¼Ÿ
#### å¾®è°ƒä¸ºä»€ä¹ˆä¸ç”¨fullsftï¼Œç”¨LoRAï¼Ÿæœ‰å¯¹æ¯”è¿‡å—ï¼Ÿ
##### å¦‚æœä½ è¯´èµ„æºä¸å¤Ÿï¼Œé‚£LoRAçœŸçš„ä¼šçœä¸‹å¾ˆå¤šæ˜¾å­˜å—ï¼ŒSFTé˜¶æ®µä½¿ç”¨äº†Deepspeedçš„ä»€ä¹ˆé˜¶æ®µï¼Œå„è‡ªæ˜¾å­˜å ç”¨äº†å¤šå°‘ï¼ŒèŠ‚çœäº†å¤šå°‘ï¼ŸLoRAçœŸçš„èƒ½è®©è®­ç»ƒæ›´å¿«å—
### å¾®è°ƒæŠ€æœ¯ç»†èŠ‚å±‚é¢ï¼š
#### è¿‡æ‹Ÿåˆæ˜¯ä»€ä¹ˆï¼Œå¦‚ä½•è§£å†³ï¼Ÿ
#### éƒ¨ç½²åœ¨äº†å¤šå°‘å¼ å¡ä¸Šï¼Œæ€ä¹ˆéƒ¨ç½²çš„ï¼Œæœ‰ä»€ä¹ˆå‘å—
#### å¾®è°ƒå‚æ•°æœ‰ä»€ä¹ˆç»éªŒå—
##### ä¸¤ä¸ªé˜¶æ®µå­¦ä¹ ç‡æ€ä¹ˆè®¾ç½®çš„ï¼Ÿè°ƒè¯•è¿‡å—ï¼Ÿå›´ç»•ç€å­¦ä¹ ç‡ä¸åŒæ¥è®²è®²å¯¹è®­ç»ƒçš„å½±å“
### å¾®è°ƒè¯„ä»·å±‚é¢ï¼Ÿ
#### BLEU-4å’ŒROUGE-Læ€ä¹ˆè®¡ç®—çš„ï¼Œé¡¹ç›®ä¸Šçš„turlenè¯„åˆ†æ€ä¹ˆæçš„ï¼Ÿ
#### é™¤äº†ä¸“ç”¨çš„benchmarkä¹‹å¤–ï¼Œé€šç”¨çš„èƒ½åŠ›ä¸ä¸¢å¤±æ˜¯æ€ä¹ˆç¡®å®šçš„ï¼Ÿ
### RLHFå±‚é¢
#### å…·ä½“æ€ä¹ˆåšçš„ï¼Ÿæµç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ
#### ä¸ºä»€ä¹ˆé€‰æ‹©DPOè€Œä¸é€‰æ‹©PPOï¼Ÿ
#### RLHFé˜¶æ®µä¸ºä»€ä¹ˆä¸ç”¨benchmarkè¯„ä»·äº†ï¼Ÿ
ï¼ˆæ²¡å¤ªå¤§å¿…è¦ï¼Œéƒ½æ˜¯åå¥½å¯¹é½ï¼‰

#### RLHFä¹‹åçš„judgeæ–¹å¼ï¼Ÿ


### RAG
### å…¶ä»–é—®é¢˜
#### é™¤äº†æ•°æ®å‡†å¤‡ï¼Œè®­ç»ƒä¹‹å¤–æœ‰ä»€ä¹ˆå…¶ä»–é—®é¢˜å—ï¼Ÿ
### 
### 
### qwenç›¸å¯¹äºå…¶ä»–å¤§æ¨¡å‹çš„ç‰¹è´¨
#### 
#### 
## æ–°æŠ€æœ¯è§†é‡
### Qwen3æœ‰äº†è§£å—ï¼Œæ¶æ„æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ
### QwQ32Bäº†è§£å—ï¼Ÿ
### DeepseekR1ï¼Ÿ
### æ¨ç†æ¨¡å‹å¯èƒ½å‡ºç°çš„é—®é¢˜æ˜¯ä»€ä¹ˆ
## åç»­æ•´ç†
1. ä¸¤ä¸ªé¡¹ç›®çš„èåˆè·‘é€š
2. å…·ä½“ç¡¬ä»¶çš„éƒ¨ç½²ï¼Œæ•°æ®çš„ç»†èŠ‚
3. badcaseçš„ä¸¾ä¾‹
4. æŠ€æœ¯çš„æ‰©å……
5. ç‰¹å®šé—®é¢˜çš„å‡†å¤‡



