---
title: 手搭大模型问题日志
urlname: wf2qlqwlyanhf9ob
date: '2025-08-12 23:37:42'
updated: '2025-09-17 19:26:13'
description: 1. 搭建minimind1.1. 环境搭建：requirment无法全部直接安装成功原因如下1.1.1. 最初是 CMake 版本太低（3.23.0 &lt; 3.25.0）默认使用的是系统中的cmake。版本是3.23，之后在系统中新安装了一个3.25版本，并进行了替换（注意不要直接删除，大概过...
---
## 搭建minimind
### 环境搭建：
requirment无法全部直接安装成功原因如下

#### <font style="color:#000000;">最初是 CMake 版本太低（3.23.0 < 3.25.0）</font>
默认使用的是系统中的cmake。版本是3.23，之后在系统中新安装了一个3.25版本，并进行了替换（注意不要直接删除，大概过程如下：

在tmp文件夹下下载并解压cmake

```plain
cd /tmp && wget https://github.com/Kitware/CMake/releases/download/v3.25.3/cmake-3.25.3-linux-x86_64.tar.gz
tar -xzf cmake-3.25.3-linux-x86_64.tar.gz
```

之后把解压的cmake放到目录下

```plain
cp -r /tmp/cmake-3.25.3-linux-x86_64/* /usr/local/
```

意义如下：  
**<font style="color:#000000;">cp -r /tmp/cmake-3.25.3-linux-x86_64/* /usr/local/</font>**

**<font style="color:#000000;">分解说明：</font>**

+ <font style="color:#000000;">cp -r</font><font style="color:#000000;">：递归复制命令，</font><font style="color:#000000;">-r</font><font style="color:#000000;"> </font><font style="color:#000000;">表示递归复制目录及其所有内容</font>
+ <font style="color:#000000;">/tmp/cmake-3.25.3-linux-x86_64/*</font><font style="color:#000000;">：源路径，表示解压后的 CMake 目录中的所有文件和文件夹</font>
+ <font style="color:#000000;">/usr/local/</font><font style="color:#000000;">：目标路径，这是 Linux 系统中存放用户自定义安装软件的标准位置</font>

**<font style="color:#000000;">具体做什么：</font>**

1. <font style="color:#000000;">将下载并解压的 CMake 3.25.3 的所有文件复制到系统路径</font>
2. <font style="color:#000000;">这包括：</font>
+ <font style="color:#000000;">bin/</font><font style="color:#000000;"> </font><font style="color:#000000;">目录（包含 cmake 可执行文件）→ 复制到</font><font style="color:#000000;"> </font><font style="color:#000000;">/usr/local/bin/</font>
+ <font style="color:#000000;">share/</font><font style="color:#000000;"> </font><font style="color:#000000;">目录（CMake 模块和文档）→ 复制到</font><font style="color:#000000;"> </font><font style="color:#000000;">/usr/local/share/</font>
+ <font style="color:#000000;">man/</font><font style="color:#000000;"> </font><font style="color:#000000;">目录（手册页）→ 复制到</font><font style="color:#000000;"> </font><font style="color:#000000;">/usr/local/man/</font>

**<font style="color:#000000;">为什么这样做：</font>**

+ <font style="color:#000000;">/usr/local/bin/</font><font style="color:#000000;"> </font><font style="color:#000000;">通常在系统的 PATH 环境变量中，所以复制到这里后，在任何地方输入</font><font style="color:#000000;"> </font><font style="color:#000000;">cmake</font><font style="color:#000000;"> </font><font style="color:#000000;">命令都会使用新版本</font>
+ <font style="color:#000000;">这相当于"安装"CMake 3.25.3，替换掉原来的旧版本 3.23.0</font>

**<font style="color:#000000;">结果：</font>**

+ <font style="color:#000000;">原来</font><font style="color:#000000;"> </font><font style="color:#000000;">cmake --version</font><font style="color:#000000;"> </font><font style="color:#000000;">显示 3.23.0</font>
+ <font style="color:#000000;">现在</font><font style="color:#000000;"> </font><font style="color:#000000;">cmake --version</font><font style="color:#000000;"> </font><font style="color:#000000;">显示 3.25.3 </font><font style="color:#000000;">✅</font>

<font style="color:#000000;">这是在 Linux 下手动安装预编译软件的标准做法。</font>

#### <font style="color:#000000;">之后是因为Pyarrow版本有问题</font>
直接装11.0.0会出现问题，并且会出现无法编译的情况，若直接安装>=15.0.0也会出错，选定一个具体的版本成功了

```plain
pip install pyarrow==15.0.2
```

之后所有的包都可以直接安装了

### 并行训练
#### <font style="color:#000000;background-color:#FFFFFF;"> </font>**<font style="color:#000000;background-color:#FFFFFF;">NCCL 共享内存错误</font>**
```plain
Error while creating shared memory segment /dev/shm/nccl-ahGuyP (size 9637888)
ncclSystemError: System call (e.g. socket, malloc) or external library call failed or device error
```

**<font style="color:#000000;background-color:#FFFFFF;">1：检查共享内存大小</font>**

```powershell
(minimind) root@33aca740a6a2:/workspace/minimind# df -h /dev/shm
Filesystem      Size  Used Avail Use% Mounted on
shm              64M   28M   37M  43% /dev/shm
(minimind) root@33aca740a6a2:/workspace/minimind#
```

**<font style="color:#000000;background-color:#FFFFFF;">2：清理共享内存</font>**

```powershell
-rw-r--r-- 1 root root     1024 Aug  5 07:11 __KMP_REGISTERED_LIB_3692871_0
-rw-r--r-- 1 root root     1024 Aug  5 07:11 __KMP_REGISTERED_LIB_3692960_0
-rw-r--r-- 1 root root     1024 Aug  5 07:11 __KMP_REGISTERED_LIB_3693080_0
-rw-r--r-- 1 root root     1024 Jun 27 09:11 __KMP_REGISTERED_LIB_369562_0
-rw-r--r-- 1 root root     1024 Jun 27 09:11 __KMP_REGISTERED_LIB_369563_0
-rw-r--r-- 1 root root     1024 Jun 27 09:11 __KMP_REGISTERED_LIB_369564_0
-rw-r--r-- 1 root root     1024 Jun 27 09:11 __KMP_REGISTERED_LIB_369565_0....
```

<font style="color:#000000;background-color:#FFFFFF;">共享内存只有64MB，但NCCL需要创建约9.6MB的共享内存段，而当前已经使用了28MB，剩余空间不足。</font>

<font style="color:#000000;background-color:#FFFFFF;"></font><font style="color:#000000;background-color:#FFFFFF;">Intel OpenMP 库的作用  
</font><font style="color:#000000;background-color:#FFFFFF;">Intel OpenMP (Open Multi-Processing) 是一个并行计算API，主要用于没啥用</font><font style="color:#000000;background-color:#FFFFFF;">  
</font><font style="color:#000000;background-color:#FFFFFF;">问题：文件没有被自动清理</font>

1. <font style="color:#000000;background-color:#FFFFFF;">进程泄漏累积  
</font><font style="color:#000000;background-color:#FFFFFF;">从你的文件列表可以看到：  
</font><font style="color:#000000;background-color:#FFFFFF;">时间跨度大：从6月27日到8月12日的文件都存在  
</font><font style="color:#000000;background-color:#FFFFFF;">数量庞大：几百个缓存文件  
</font><font style="color:#000000;background-color:#FFFFFF;">原因：  
</font><font style="color:#000000;background-color:#FFFFFF;">Jupyter notebook频繁重启  
</font><font style="color:#000000;background-color:#FFFFFF;">异常终止的Python进程  
</font><font style="color:#000000;background-color:#FFFFFF;">多次运行深度学习任务</font>
2. <font style="color:#000000;background-color:#FFFFFF;">Docker容器限制  
</font><font style="color:#000000;background-color:#FFFFFF;">Apply to train_pretra...  
</font><font style="color:#000000;background-color:#FFFFFF;">Run  
</font><font style="color:#000000;background-color:#FFFFFF;">Docker默认限制：共享内存只有64MB  
</font><font style="color:#000000;background-color:#FFFFFF;">实际需求：NCCL需要约9.6MB × 4个进程 = 38MB+  
</font><font style="color:#000000;background-color:#FFFFFF;">已用空间：28MB被OpenMP缓存占用</font>

<font style="color:#000000;background-color:#FFFFFF;">所以得出结论可以清理..直接全清理了</font>

<font style="color:#000000;background-color:#FFFFFF;">rm -f /dev/shm/</font>

**<font style="color:#000000;background-color:#FFFFFF;">3：当然claude提供了另一个方法：之后训练，有效，但没有细研究为什么ok</font>**<font style="color:#000000;background-color:#FFFFFF;">  
</font><font style="color:#000000;background-color:#FFFFFF;">export NCCL_SHM_DISABLE=1    # 禁用共享内存</font>

<font style="color:#000000;background-color:#FFFFFF;">export NCCL_P2P_DISABLE=1    # 禁用点对点通信</font>

<font style="color:#000000;background-color:#FFFFFF;">export OMP_NUM_THREADS=4     # 限制OpenMP线程数</font>

<font style="color:#000000;background-color:#FFFFFF;"></font>

#### DeepSpeed修正minimind进行多卡训练
